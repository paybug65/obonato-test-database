<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Case of Emergency ‚Äî Tiriwe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="js/tiriwe-core.js"></script>
    <style>
        :root {
            --green: #2E7D32; --green-light: #43A047; --green-dark: #1B5E20; --green-pale: #E8F5E9;
            --orange: #FF9800; --orange-pale: #FFF3E0;
            --red: #F44336; --red-pale: #FFEBEE;
            --blue: #1565C0; --blue-pale: #E3F2FD;
            --white: #ffffff; --off-white: #f8fafc;
            --text: #1e293b; --text-mid: #475569; --text-muted: #94a3b8;
            --border: #e2e8f0; --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text); background: var(--off-white); line-height: 1.6; }

        .page-container { max-width: 720px; margin: 0 auto; padding: 32px 24px 80px; }
        .back-link { display: inline-flex; align-items: center; gap: 6px; color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 500; margin-bottom: 20px; }
        .back-link:hover { color: var(--green); }
        .page-header { margin-bottom: 28px; }
        .page-header h1 { font-size: 28px; font-weight: 800; }
        .page-header p { color: var(--text-mid); font-size: 15px; margin-top: 4px; }

        /* Sections */
        .section { background: white; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; overflow: hidden; }
        .section-hdr { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .section-hdr-icon { font-size: 20px; }
        .section-hdr h2 { font-size: 16px; font-weight: 700; flex: 1; }
        .section-body { padding: 24px; }
        .section-note { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.6; }

        /* Forms */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-mid); margin-bottom: 6px; }
        .form-group label .hint { font-weight: 400; color: var(--text-muted); margin-left: 4px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 14px; transition: all 0.2s; background: var(--off-white);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--green); background: white; box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* Visibility selector */
        .vis-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 10px 14px; background: var(--off-white); border-radius: 8px; }
        .vis-row label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 0; white-space: nowrap; }
        .vis-row select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: inherit; }

        /* Data tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
        .data-table th { text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 6px; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 10px 6px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table td:last-child { text-align: right; width: 36px; }
        .data-table input, .data-table select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 12px; width: 100%; background: white; }
        .data-table input:focus, .data-table select:focus { outline: none; border-color: var(--green); }

        .expiry-warning { font-size: 11px; font-weight: 600; margin-top: 2px; }
        .expiry-warning.expired { color: var(--red); }
        .expiry-warning.soon { color: var(--orange); }
        .expiry-warning.ok { color: var(--green); }

        .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; font-style: italic; }
        .add-row-bar { display: flex; justify-content: flex-end; margin-top: 12px; }

        .btn { padding: 12px 24px; border-radius: 8px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-primary:disabled { background: #A5D6A7; cursor: not-allowed; }
        .btn-secondary { background: var(--off-white); color: var(--text-mid); border: 1.5px solid var(--border); }
        .btn-secondary:hover { background: white; border-color: var(--text-muted); }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px; border-radius: 4px; }
        .btn-remove:hover { color: var(--red); background: var(--red-pale); }

        .save-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .save-status { font-size: 13px; color: var(--green); font-weight: 500; opacity: 0; transition: opacity 0.3s; }
        .save-status.visible { opacity: 1; }

        /* Contact type badge */
        .contact-badge { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
        .contact-badge.tiriwe { background: var(--green-pale); color: var(--green); }
        .contact-badge.external { background: var(--blue-pale); color: var(--blue); }

        /* Search user inline */
        .user-search-wrap { position: relative; }
        .user-search-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px; display: none; max-height: 160px; overflow-y: auto; }
        .user-search-results.show { display: block; }
        .user-search-result { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .user-search-result:last-child { border-bottom: none; }
        .user-search-result:hover { background: var(--green-pale); }

        /* Loading */
        .loading-screen { display: flex; align-items: center; justify-content: center; min-height: 60vh; flex-direction: column; gap: 16px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .form-row, .form-row.triple { grid-template-columns: 1fr; }
            .page-container { padding: 16px 16px 80px; }
            .data-table { font-size: 12px; }
        }
    </style>
</head>
<body>

<nav id="tiriwe-nav"></nav>

<div class="page-container" id="loading-screen">
    <div class="loading-screen">
        <div class="loading-spinner"></div>
        <div style="color:var(--text-muted); font-size:14px;">Loading emergency info...</div>
    </div>
</div>

<div class="page-container" id="main-content" style="display:none;">

    <a href="settings.html" class="back-link">‚Üê Back to Settings</a>

    <div class="page-header">
        <h1>In Case of Emergency</h1>
        <p>Medical details, travel documents & emergency contacts. You control who sees each section.</p>
    </div>

    <!-- ==================== MEDICAL INFO ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üè•</span>
            <h2>Medical Information</h2>
        </div>
        <div class="section-body">
            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-medical">
                    <option value="only_me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts" selected>Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Blood Type</label>
                    <select id="blood_type">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Organ Donor</label>
                    <select id="organ_donor">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Allergies</label>
                    <textarea id="allergies" placeholder="e.g. Penicillin, bee stings, peanuts..." rows="2"></textarea>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Medical Conditions</label>
                    <textarea id="conditions" placeholder="e.g. Asthma, diabetes, epilepsy..." rows="2"></textarea>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Additional Medical Notes</label>
                    <textarea id="medical_notes" placeholder="Anything a first responder should know..." rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MEDICATIONS ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üíä</span>
            <h2>Current Medications</h2>
        </div>
        <div class="section-body">
            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-medications">
                    <option value="only_me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts" selected>Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>
            <table class="data-table" id="med-table">
                <thead>
                    <tr><th>Medication</th><th>Dosage</th><th>Frequency</th><th>Expiry</th><th></th></tr>
                </thead>
                <tbody id="med-body"></tbody>
            </table>
            <div class="empty-state" id="med-empty">No medications added.</div>
            <div class="add-row-bar">
                <button class="btn btn-sm btn-secondary" onclick="addMedRow()">+ Add Medication</button>
            </div>
        </div>
    </div>

    <!-- ==================== PASSPORTS ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üõÇ</span>
            <h2>Passports</h2>
        </div>
        <div class="section-body">
            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-passports">
                    <option value="only_me" selected>Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts">Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>
            <table class="data-table" id="passport-table">
                <thead>
                    <tr><th>Country</th><th>Passport Number</th><th>Expiry Date</th><th></th></tr>
                </thead>
                <tbody id="passport-body"></tbody>
            </table>
            <div class="empty-state" id="passport-empty">No passports added.</div>
            <div class="add-row-bar">
                <button class="btn btn-sm btn-secondary" onclick="addPassportRow()">+ Add Passport</button>
            </div>
        </div>
    </div>

    <!-- ==================== VISAS ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üìã</span>
            <h2>Visas</h2>
        </div>
        <div class="section-body">
            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-visas">
                    <option value="only_me" selected>Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts">Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>
            <table class="data-table" id="visa-table">
                <thead>
                    <tr><th>Country</th><th>Visa Type</th><th>Expiry Date</th><th></th></tr>
                </thead>
                <tbody id="visa-body"></tbody>
            </table>
            <div class="empty-state" id="visa-empty">No visas added.</div>
            <div class="add-row-bar">
                <button class="btn btn-sm btn-secondary" onclick="addVisaRow()">+ Add Visa</button>
            </div>
        </div>
    </div>

    <!-- ==================== TRAVEL INSURANCE ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üõ°Ô∏è</span>
            <h2>Travel Insurance</h2>
        </div>
        <div class="section-body">
            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-insurance">
                    <option value="only_me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts" selected>Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>
            <table class="data-table" id="insurance-table">
                <thead>
                    <tr><th>Provider</th><th>Policy No.</th><th>Emergency Phone</th><th>Expiry</th><th></th></tr>
                </thead>
                <tbody id="insurance-body"></tbody>
            </table>
            <div class="empty-state" id="insurance-empty">No insurance policies added.</div>
            <div class="add-row-bar">
                <button class="btn btn-sm btn-secondary" onclick="addInsuranceRow()">+ Add Policy</button>
            </div>
        </div>
    </div>

    <!-- ==================== EMERGENCY CONTACTS ==================== -->
    <div class="section">
        <div class="section-hdr">
            <span class="section-hdr-icon">üìû</span>
            <h2>Emergency Contacts</h2>
        </div>
        <div class="section-body">
            <p class="section-note">Add people to notify in an emergency. You can add external contacts or link existing Tiriwe users by their username.</p>

            <div class="vis-row">
                <label>Who can see:</label>
                <select id="vis-contacts">
                    <option value="only_me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="emergency_contacts" selected>Emergency Contacts</option>
                    <option value="confirmed_helpers">Confirmed Helpers</option>
                    <option value="all_verified">All Verified Users</option>
                </select>
            </div>

            <table class="data-table" id="contact-table">
                <thead>
                    <tr><th>Name</th><th>Relationship</th><th>Phone</th><th>Type</th><th></th></tr>
                </thead>
                <tbody id="contact-body"></tbody>
            </table>
            <div class="empty-state" id="contact-empty">No emergency contacts added.</div>

            <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                <button class="btn btn-sm btn-secondary" onclick="addContactRow()">+ Add External Contact</button>
                <button class="btn btn-sm btn-secondary" onclick="showTiriweUserSearch()" style="border-color:var(--green-pale); color:var(--green);">+ Link Tiriwe User</button>
            </div>

            <!-- Tiriwe user search (hidden by default) -->
            <div id="tiriwe-user-search" style="display:none; margin-top:16px; padding:16px; background:var(--green-pale); border-radius:8px;">
                <label style="font-size:13px; font-weight:600; color:var(--green-dark); display:block; margin-bottom:8px;">Search Tiriwe User by Display Name</label>
                <div class="user-search-wrap">
                    <input type="text" id="tiriwe-search-input" placeholder="e.g. SwiftRiver742" style="padding:10px 14px; border:1.5px solid var(--border); border-radius:8px; width:100%; font-size:14px;">
                    <div class="user-search-results" id="tiriwe-search-results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SAVE ==================== -->
    <div class="save-bar">
        <span class="save-status" id="save-status">‚úÖ Saved</span>
        <button class="btn btn-primary" id="btn-save" onclick="saveEmergencyInfo()" style="padding:14px 32px; font-size:16px;">
            Save Emergency Info
        </button>
    </div>

</div>

<script>
// ====================================================================
// COUNTRY LIST (ISO)
// ====================================================================
const COUNTRIES = [
    'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina','Armenia',
    'Australia','Austria','Azerbaijan','Bahamas','Bahrain','Bangladesh','Barbados','Belarus','Belgium',
    'Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana','Brazil','Brunei','Bulgaria',
    'Burkina Faso','Burundi','Cabo Verde','Cambodia','Cameroon','Canada','Central African Republic','Chad',
    'Chile','China','Colombia','Comoros','Congo','Costa Rica','Croatia','Cuba','Cyprus','Czech Republic',
    'Denmark','Djibouti','Dominica','Dominican Republic','Ecuador','Egypt','El Salvador','Equatorial Guinea',
    'Eritrea','Estonia','Eswatini','Ethiopia','Fiji','Finland','France','Gabon','Gambia','Georgia','Germany',
    'Ghana','Greece','Grenada','Guatemala','Guinea','Guinea-Bissau','Guyana','Haiti','Honduras','Hungary',
    'Iceland','India','Indonesia','Iran','Iraq','Ireland','Israel','Italy','Jamaica','Japan','Jordan',
    'Kazakhstan','Kenya','Kiribati','Kosovo','Kuwait','Kyrgyzstan','Laos','Latvia','Lebanon','Lesotho',
    'Liberia','Libya','Liechtenstein','Lithuania','Luxembourg','Madagascar','Malawi','Malaysia','Maldives',
    'Mali','Malta','Marshall Islands','Mauritania','Mauritius','Mexico','Micronesia','Moldova','Monaco',
    'Mongolia','Montenegro','Morocco','Mozambique','Myanmar','Namibia','Nauru','Nepal','Netherlands',
    'New Zealand','Nicaragua','Niger','Nigeria','North Korea','North Macedonia','Norway','Oman','Pakistan',
    'Palau','Palestine','Panama','Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal',
    'Qatar','Romania','Russia','Rwanda','Saint Kitts and Nevis','Saint Lucia','Saint Vincent and the Grenadines',
    'Samoa','San Marino','Sao Tome and Principe','Saudi Arabia','Senegal','Serbia','Seychelles','Sierra Leone',
    'Singapore','Slovakia','Slovenia','Solomon Islands','Somalia','South Africa','South Korea','South Sudan',
    'Spain','Sri Lanka','Sudan','Suriname','Sweden','Switzerland','Syria','Taiwan','Tajikistan','Tanzania',
    'Thailand','Timor-Leste','Togo','Tonga','Trinidad and Tobago','Tunisia','Turkey','Turkmenistan','Tuvalu',
    'Uganda','Ukraine','United Arab Emirates','United Kingdom','United States','Uruguay','Uzbekistan',
    'Vanuatu','Vatican City','Venezuela','Vietnam','Yemen','Zambia','Zimbabwe'
];

function countryOptions() {
    return '<option value="">‚Äî Select ‚Äî</option>' + COUNTRIES.map(c => `<option value="${c}">${c}</option>`).join('');
}

// ====================================================================
// DATA STATE
// ====================================================================
let medications = [];
let passports = [];
let visas = [];
let insurance = [];
let contacts = [];

// ====================================================================
// INIT
// ====================================================================
Tiriwe.ready().then(() => {
    const user = Tiriwe.user;
    if (!user) return;

    const ice = (user.metadata && user.metadata.ice) || {};
    const iceVis = (user.metadata && user.metadata.ice_visibility) || {};

    // Medical fields
    document.getElementById('blood_type').value = ice.blood_type || '';
    document.getElementById('organ_donor').value = ice.organ_donor || '';
    document.getElementById('allergies').value = ice.allergies || '';
    document.getElementById('conditions').value = ice.conditions || '';
    document.getElementById('medical_notes').value = ice.medical_notes || '';

    // Visibility
    document.getElementById('vis-medical').value = iceVis.medical || 'emergency_contacts';
    document.getElementById('vis-medications').value = iceVis.medications || 'emergency_contacts';
    document.getElementById('vis-passports').value = iceVis.passports || 'only_me';
    document.getElementById('vis-visas').value = iceVis.visas || 'only_me';
    document.getElementById('vis-insurance').value = iceVis.insurance || 'emergency_contacts';
    document.getElementById('vis-contacts').value = iceVis.contacts || 'emergency_contacts';

    // Tables
    medications = ice.medications || [];
    passports = ice.passports || [];
    visas = ice.visas || [];
    insurance = ice.insurance || [];
    contacts = ice.contacts || [];

    renderMeds();
    renderPassports();
    renderVisas();
    renderInsurance();
    renderContacts();

    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
});

// ====================================================================
// EXPIRY HELPER
// ====================================================================
function expiryHtml(dateStr) {
    if (!dateStr) return '';
    const exp = new Date(dateStr);
    const now = new Date();
    const daysLeft = Math.ceil((exp - now) / (1000*60*60*24));

    if (daysLeft < 0) return '<div class="expiry-warning expired">‚ö† Expired</div>';
    if (daysLeft < 90) return `<div class="expiry-warning soon">‚ö† ${daysLeft} days left</div>`;
    return `<div class="expiry-warning ok">‚úì ${daysLeft} days</div>`;
}

// ====================================================================
// MEDICATIONS
// ====================================================================
function renderMeds() {
    const tbody = document.getElementById('med-body');
    const empty = document.getElementById('med-empty');
    tbody.innerHTML = '';
    if (medications.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    medications.forEach((m, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input value="${esc(m.name)}" onchange="medications[${i}].name=this.value" placeholder="Name"></td>
            <td><input value="${esc(m.dosage)}" onchange="medications[${i}].dosage=this.value" placeholder="e.g. 10mg"></td>
            <td><input value="${esc(m.frequency)}" onchange="medications[${i}].frequency=this.value" placeholder="e.g. Daily"></td>
            <td style="min-width:110px;"><input type="date" value="${m.expiry||''}" onchange="medications[${i}].expiry=this.value; renderMeds()">${expiryHtml(m.expiry)}</td>
            <td><button class="btn-remove" onclick="medications.splice(${i},1); renderMeds()">‚úï</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function addMedRow() {
    medications.push({ name: '', dosage: '', frequency: '', expiry: '', notes: '' });
    renderMeds();
}

// ====================================================================
// PASSPORTS
// ====================================================================
function renderPassports() {
    const tbody = document.getElementById('passport-body');
    const empty = document.getElementById('passport-empty');
    tbody.innerHTML = '';
    if (passports.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    passports.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><select onchange="passports[${i}].country=this.value">${countryOptions()}</select></td>
            <td><input value="${esc(p.number)}" onchange="passports[${i}].number=this.value" placeholder="Number"></td>
            <td style="min-width:110px;"><input type="date" value="${p.expiry||''}" onchange="passports[${i}].expiry=this.value; renderPassports()">${expiryHtml(p.expiry)}</td>
            <td><button class="btn-remove" onclick="passports.splice(${i},1); renderPassports()">‚úï</button></td>
        `;
        // Set country dropdown value after render
        const sel = tr.querySelector('select');
        sel.value = p.country || '';
        tbody.appendChild(tr);
    });
}

function addPassportRow() {
    passports.push({ country: '', number: '', expiry: '' });
    renderPassports();
}

// ====================================================================
// VISAS
// ====================================================================
function renderVisas() {
    const tbody = document.getElementById('visa-body');
    const empty = document.getElementById('visa-empty');
    tbody.innerHTML = '';
    if (visas.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    visas.forEach((v, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><select onchange="visas[${i}].country=this.value">${countryOptions()}</select></td>
            <td><input value="${esc(v.type)}" onchange="visas[${i}].type=this.value" placeholder="e.g. Working Holiday"></td>
            <td style="min-width:110px;"><input type="date" value="${v.expiry||''}" onchange="visas[${i}].expiry=this.value; renderVisas()">${expiryHtml(v.expiry)}</td>
            <td><button class="btn-remove" onclick="visas.splice(${i},1); renderVisas()">‚úï</button></td>
        `;
        tr.querySelector('select').value = v.country || '';
        tbody.appendChild(tr);
    });
}

function addVisaRow() {
    visas.push({ country: '', type: '', expiry: '' });
    renderVisas();
}

// ====================================================================
// INSURANCE
// ====================================================================
function renderInsurance() {
    const tbody = document.getElementById('insurance-body');
    const empty = document.getElementById('insurance-empty');
    tbody.innerHTML = '';
    if (insurance.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    insurance.forEach((ins, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input value="${esc(ins.provider)}" onchange="insurance[${i}].provider=this.value" placeholder="Provider"></td>
            <td><input value="${esc(ins.policy)}" onchange="insurance[${i}].policy=this.value" placeholder="Policy #"></td>
            <td><input value="${esc(ins.phone)}" onchange="insurance[${i}].phone=this.value" placeholder="+1 800..."></td>
            <td style="min-width:110px;"><input type="date" value="${ins.expiry||''}" onchange="insurance[${i}].expiry=this.value; renderInsurance()">${expiryHtml(ins.expiry)}</td>
            <td><button class="btn-remove" onclick="insurance.splice(${i},1); renderInsurance()">‚úï</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function addInsuranceRow() {
    insurance.push({ provider: '', policy: '', phone: '', expiry: '' });
    renderInsurance();
}

// ====================================================================
// EMERGENCY CONTACTS
// ====================================================================
function renderContacts() {
    const tbody = document.getElementById('contact-body');
    const empty = document.getElementById('contact-empty');
    tbody.innerHTML = '';
    if (contacts.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    contacts.forEach((c, i) => {
        const tr = document.createElement('tr');
        const isTiriwe = c.tiriwe_user_id ? true : false;
        const badge = isTiriwe
            ? '<span class="contact-badge tiriwe">Tiriwe</span>'
            : '<span class="contact-badge external">External</span>';

        if (isTiriwe) {
            tr.innerHTML = `
                <td style="font-weight:500;">${esc(c.name)} ${badge}</td>
                <td><input value="${esc(c.relationship)}" onchange="contacts[${i}].relationship=this.value" placeholder="Relationship"></td>
                <td style="color:var(--text-muted); font-size:12px;">Via Tiriwe</td>
                <td></td>
                <td><button class="btn-remove" onclick="contacts.splice(${i},1); renderContacts()">‚úï</button></td>
            `;
        } else {
            tr.innerHTML = `
                <td><input value="${esc(c.name)}" onchange="contacts[${i}].name=this.value" placeholder="Name"> ${badge}</td>
                <td><input value="${esc(c.relationship)}" onchange="contacts[${i}].relationship=this.value" placeholder="e.g. Partner"></td>
                <td><input value="${esc(c.phone)}" onchange="contacts[${i}].phone=this.value" placeholder="+64..."></td>
                <td></td>
                <td><button class="btn-remove" onclick="contacts.splice(${i},1); renderContacts()">‚úï</button></td>
            `;
        }
        tbody.appendChild(tr);
    });
}

function addContactRow() {
    contacts.push({ name: '', relationship: '', phone: '', email: '', type: 'external' });
    renderContacts();
}

// ====================================================================
// TIRIWE USER SEARCH
// ====================================================================
function showTiriweUserSearch() {
    const el = document.getElementById('tiriwe-user-search');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    if (el.style.display === 'block') {
        document.getElementById('tiriwe-search-input').focus();
    }
}

let tiriweSearchTimeout = null;
document.getElementById('tiriwe-search-input').addEventListener('input', (e) => {
    clearTimeout(tiriweSearchTimeout);
    const q = e.target.value.trim();
    if (q.length < 3) { document.getElementById('tiriwe-search-results').classList.remove('show'); return; }
    tiriweSearchTimeout = setTimeout(() => searchTiriweUser(q), 400);
});

async function searchTiriweUser(query) {
    const resultsEl = document.getElementById('tiriwe-search-results');
    resultsEl.innerHTML = '<div class="user-search-result" style="color:var(--text-muted);">Searching...</div>';
    resultsEl.classList.add('show');

    try {
        const { data, error } = await Tiriwe.sb
            .from('users')
            .select('id, display_name, avatar_emoji')
            .ilike('display_name', `%${query}%`)
            .neq('id', Tiriwe.user.id)
            .is('deleted_at', null)
            .limit(5);

        if (error || !data || data.length === 0) {
            resultsEl.innerHTML = '<div class="user-search-result" style="color:var(--text-muted);">No users found</div>';
            return;
        }

        resultsEl.innerHTML = '';
        data.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-search-result';
            div.innerHTML = `<span>${u.avatar_emoji || 'üë§'}</span> <strong>${esc(u.display_name)}</strong>`;
            div.addEventListener('click', () => linkTiriweUser(u));
            resultsEl.appendChild(div);
        });
    } catch (err) {
        resultsEl.innerHTML = '<div class="user-search-result" style="color:var(--red);">Search failed</div>';
    }
}

function linkTiriweUser(user) {
    if (contacts.find(c => c.tiriwe_user_id === user.id)) {
        Tiriwe.showToast('Already added', 'warning');
        return;
    }
    contacts.push({
        name: user.display_name,
        relationship: '',
        phone: '',
        email: '',
        type: 'tiriwe',
        tiriwe_user_id: user.id,
        avatar_emoji: user.avatar_emoji
    });
    renderContacts();
    document.getElementById('tiriwe-search-results').classList.remove('show');
    document.getElementById('tiriwe-search-input').value = '';
    Tiriwe.showToast('Linked ' + user.display_name, 'success');
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-search-wrap')) {
        document.getElementById('tiriwe-search-results').classList.remove('show');
    }
});

// ====================================================================
// SAVE
// ====================================================================
async function saveEmergencyInfo() {
    const btn = document.getElementById('btn-save');
    const status = document.getElementById('save-status');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    status.classList.remove('visible');

    const user = Tiriwe.user;
    if (!user) return;

    const existingMeta = user.metadata || {};

    const ice = {
        blood_type: document.getElementById('blood_type').value || null,
        organ_donor: document.getElementById('organ_donor').value || null,
        allergies: document.getElementById('allergies').value.trim() || null,
        conditions: document.getElementById('conditions').value.trim() || null,
        medical_notes: document.getElementById('medical_notes').value.trim() || null,
        medications: medications,
        passports: passports,
        visas: visas,
        insurance: insurance,
        contacts: contacts,
    };

    const iceVis = {
        medical: document.getElementById('vis-medical').value,
        medications: document.getElementById('vis-medications').value,
        passports: document.getElementById('vis-passports').value,
        visas: document.getElementById('vis-visas').value,
        insurance: document.getElementById('vis-insurance').value,
        contacts: document.getElementById('vis-contacts').value,
    };

    const updates = {
        metadata: {
            ...existingMeta,
            ice: ice,
            ice_visibility: iceVis,
        },
        updated_at: new Date().toISOString(),
    };

    const { error } = await Tiriwe.sb.from('users').update(updates).eq('id', user.id);

    if (error) {
        Tiriwe.showToast('Failed to save: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Save Emergency Info';
        return;
    }

    Tiriwe.showToast('Emergency info saved', 'success');
    status.textContent = '‚úÖ Saved';
    status.classList.add('visible');
    btn.disabled = false;
    btn.textContent = 'Save Emergency Info';
    setTimeout(() => status.classList.remove('visible'), 3000);
}

// ====================================================================
// UTILS
// ====================================================================
function esc(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>

</body>
</html>
