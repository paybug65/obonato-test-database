<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato - I exist because you exist</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet CSS & JS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #1F4788;
            --primary-dark: #163560;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }
        
        .logo h1 { font-size: 24px; font-weight: 700; }
        .logo span { font-size: 11px; opacity: 0.8; display: block; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        
        .pending-badge {
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .user-info { font-size: 14px; }
        .btn-signout {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-signout:hover { background: rgba(255,255,255,0.3); }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            background: var(--card);
            border-radius: 12px 12px 0 0;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tab {
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            position: relative;
        }
        .tab:hover { color: var(--primary); background: #f1f5f9; }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }
        .tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-content {
            display: none;
            background: var(--card);
            padding: 30px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 500px;
        }
        .tab-content.active { display: block; }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card h4 {
            font-size: 16px;
            margin: 24px 0 16px;
            color: var(--text);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-block { width: 100%; justify-content: center; }
        
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        
        /* Map Styles */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border);
            margin-bottom: 20px;
        }
        #helpersMap, #homeMap { height: 100%; width: 100%; }
        
        .map-legend {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 13px;
        }
        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Helper Cards */
        .helper-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .helper-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .helper-card h4 { margin-bottom: 8px; }
        .helper-card .distance { color: var(--text-light); font-size: 14px; }
        .helper-card .services { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
        .helper-card .service-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .helper-card .actions { margin-top: 16px; display: flex; gap: 8px; }
        
        /* Checkbox Groups */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 16px; }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label { cursor: pointer; font-size: 14px; }
        
        /* Radio Groups */
        .radio-group { display: flex; gap: 24px; flex-wrap: wrap; }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg);
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-item:hover { border-color: var(--primary); }
        .radio-item.selected {
            border-color: var(--primary);
            background: #eef2ff;
        }
        .radio-item input { width: 18px; height: 18px; }
        .radio-item label { cursor: pointer; font-weight: 500; }
        
        /* Location Box */
        .location-capture-box {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .location-capture-box.has-location {
            border-style: solid;
            border-color: var(--success);
            background: #f0fdf4;
        }
        .location-display {
            font-family: monospace;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 12px;
        }
        
        /* SOS Styles */
        .sos-container { text-align: center; padding: 40px; }
        .sos-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff4444, #cc0000);
            border: none;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(255,0,0,0.4);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .sos-button:hover { transform: scale(1.05); }
        .sos-button.holding {
            background: linear-gradient(145deg, #ff6666, #ff0000);
            transform: scale(0.95);
        }
        .sos-button span { font-size: 14px; margin-top: 8px; font-weight: normal; }
        .sos-progress {
            width: 200px;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin: 20px auto;
            overflow: hidden;
        }
        .sos-progress-bar {
            height: 100%;
            background: var(--danger);
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Activity/Interaction Cards */
        .interaction-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .interaction-card.needs-feedback {
            border-color: var(--warning);
            background: #fffbeb;
        }
        .interaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .interaction-type {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--bg);
            color: var(--text-light);
        }
        .interaction-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-needs-feedback { background: #fee2e2; color: #991b1b; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            font-size: 20px;
            color: var(--primary);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Feedback Rating */
        .rating-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 24px 0;
        }
        .rating-btn {
            padding: 20px 30px;
            border: 3px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .rating-btn:hover { transform: scale(1.05); }
        .rating-btn.selected { border-width: 3px; }
        .rating-btn.positive.selected { border-color: var(--success); background: #f0fdf4; }
        .rating-btn.neutral.selected { border-color: var(--warning); background: #fffbeb; }
        .rating-btn.negative.selected { border-color: var(--danger); background: #fef2f2; }
        .rating-btn .emoji { font-size: 36px; display: block; margin-bottom: 8px; }
        .rating-btn .label { font-size: 14px; font-weight: 600; }
        
        /* Verification Photo */
        .photo-upload-box {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-upload-box:hover { border-color: var(--primary); background: #f8fafc; }
        .photo-upload-box.has-photo { border-style: solid; border-color: var(--success); }
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        
        @media (max-width: 768px) {
            .tabs { flex-wrap: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; height: auto; padding: 12px 0; gap: 12px; }
            .radio-group { flex-direction: column; gap: 12px; }
            .map-container { height: 300px; }
            .rating-buttons { flex-direction: column; }
            .rating-btn { padding: 16px 20px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>üåç Obonato</h1>
                <span>I exist because you exist</span>
            </div>
            <div class="header-right">
                <span id="connectionStatus" class="status-badge status-disconnected">Connecting...</span>
                <span id="pendingFeedback" class="pending-badge hidden" onclick="showTab('activity', document.querySelector('.tab[data-tab=activity]'))">‚ö†Ô∏è Feedback Required</span>
                <div id="userArea" class="hidden">
                    <span class="user-info" id="userEmail"></span>
                    <button class="btn-signout" onclick="handleSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="auth" onclick="showTab('auth', this)">üîê Sign In</button>
            <button class="tab" data-tab="profile" onclick="showTab('profile', this)">üë§ Profile</button>
            <button class="tab" data-tab="availability" onclick="showTab('availability', this)">üìç Availability</button>
            <button class="tab" data-tab="helpers" onclick="showTab('helpers', this)">üó∫Ô∏è Find Helpers</button>
            <button class="tab" data-tab="activity" onclick="showTab('activity', this)">üìã Activity</button>
            <button class="tab" data-tab="sos" onclick="showTab('sos', this)">üö® SOS</button>
        </div>
        
        <!-- Auth Tab -->
        <div id="auth" class="tab-content active">
            <div class="grid-2">
                <div class="card">
                    <h3>üîê Sign In</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="signInEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signInPassword" placeholder="Your password">
                    </div>
                    <button class="btn btn-primary" onclick="handleSignIn()">Sign In</button>
                    <div id="signInResult" style="margin-top: 16px;"></div>
                </div>
                
                <div class="card">
                    <h3>üìù Sign Up</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="signUpEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signUpPassword" placeholder="Min 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" class="form-control" id="signUpName" placeholder="How others will see you">
                    </div>
                    <button class="btn btn-success" onclick="handleSignUp()">Create Account</button>
                    <div id="signUpResult" style="margin-top: 16px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="card">
                <h3>üë§ Your Profile</h3>
                
                <h4>üìã Personal Information</h4>
                <div class="grid-3">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" class="form-control" id="profileFirstName">
                    </div>
                    <div class="form-group">
                        <label>Surname</label>
                        <input type="text" class="form-control" id="profileSurname">
                    </div>
                    <div class="form-group">
                        <label>Known As / Display Name</label>
                        <input type="text" class="form-control" id="profileKnownAs">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Mobile Phone</label>
                        <input type="tel" class="form-control" id="profileMobile" placeholder="+64 21 123 4567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="profileEmail" readonly>
                    </div>
                </div>
                
                <h4>üè† Home Address</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Suburb / Area</label>
                        <input type="text" class="form-control" id="profileSuburb">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" class="form-control" id="profileCity">
                    </div>
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" class="form-control" id="profileCountry">
                    </div>
                    <div class="form-group">
                        <label>Post Code</label>
                        <input type="text" class="form-control" id="profilePostCode">
                    </div>
                </div>
                
                <h4>üìç Home Location</h4>
                <div class="grid-2">
                    <div>
                        <div class="location-capture-box" id="homeLocationBox">
                            <div class="btn-group" style="justify-content: center; margin-bottom: 16px;">
                                <button class="btn btn-primary btn-sm" onclick="captureHomeGPS()">üìç Use Device GPS</button>
                                <button class="btn btn-secondary btn-sm" onclick="showManualEntry()">‚úèÔ∏è Manual</button>
                            </div>
                            <div id="manualGpsEntry" class="hidden" style="margin-top: 16px;">
                                <div class="grid-2" style="max-width: 300px; margin: 0 auto;">
                                    <input type="text" class="form-control" id="profileHomeLat" placeholder="Latitude">
                                    <input type="text" class="form-control" id="profileHomeLng" placeholder="Longitude">
                                </div>
                            </div>
                            <div class="location-display" id="homeLocationDisplay">No location set</div>
                        </div>
                    </div>
                    <div class="map-container" id="homeMapContainer" style="height: 200px;">
                        <div id="homeMap"></div>
                    </div>
                </div>
                
                <h4>üöó Traveler Type</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="typeMoto"><label for="typeMoto">üèçÔ∏è Motorcyclist</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeCyclist"><label for="typeCyclist">üö¥ Cyclist</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="type4wd"><label for="type4wd">üöô 4WD / Overlander</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeYacht"><label for="typeYacht">‚õµ Sailor</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeHiker"><label for="typeHiker">ü•æ Hiker</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeTrucker"><label for="typeTrucker">üöõ Trucker</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="typeRV"><label for="typeRV">üöê RV / Campervan</label></div>
                </div>
                
                <h4>üö® Emergency Contact</h4>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Contact Name</label>
                        <input type="text" class="form-control" id="emergencyName">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="tel" class="form-control" id="emergencyPhone">
                    </div>
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" class="form-control" id="emergencyEmail">
                    </div>
                </div>
                
                <h4>‚öôÔ∏è Preferences</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Distance Units</label>
                        <div class="radio-group">
                            <div class="radio-item selected" onclick="selectRadio('unitDistance', 'km')">
                                <input type="radio" name="unitDistance" value="km" checked>
                                <label>Kilometres</label>
                            </div>
                            <div class="radio-item" onclick="selectRadio('unitDistance', 'miles')">
                                <input type="radio" name="unitDistance" value="miles">
                                <label>Miles</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature Units</label>
                        <div class="radio-group">
                            <div class="radio-item selected" onclick="selectRadio('unitTemp', 'celsius')">
                                <input type="radio" name="unitTemp" value="celsius" checked>
                                <label>Celsius (¬∞C)</label>
                            </div>
                            <div class="radio-item" onclick="selectRadio('unitTemp', 'fahrenheit')">
                                <input type="radio" name="unitTemp" value="fahrenheit">
                                <label>Fahrenheit (¬∞F)</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="handleSaveProfile()">üíæ Save Profile</button>
                </div>
                <div id="profileResult" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <!-- Availability Tab -->
        <div id="availability" class="tab-content">
            <div class="card">
                <h3>üìç Your Availability</h3>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="availActive" checked style="width: 20px; height: 20px; margin-right: 8px;">
                        <strong>I am available to help others</strong>
                    </label>
                </div>
                
                <h4>üìç Current Location</h4>
                <div class="grid-2">
                    <div>
                        <button class="btn btn-secondary" onclick="getCurrentLocation()" style="margin-bottom: 12px;">üìç Use Current Location</button>
                        <div class="grid-2">
                            <input type="text" class="form-control" id="availLat" placeholder="Latitude">
                            <input type="text" class="form-control" id="availLng" placeholder="Longitude">
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label>Location Description</label>
                            <input type="text" class="form-control" id="availLocation" placeholder="e.g., Auckland CBD">
                        </div>
                    </div>
                    <div class="map-container" style="height: 200px;">
                        <div id="availMap"></div>
                    </div>
                </div>
                
                <h4>ü§ù Services You Can Provide</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="canPickup"><label for="canPickup">üöó Pickup / Rescue</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canGarage"><label for="canGarage">üîß Garage / Workshop</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canStay"><label for="canStay">üè† Accommodation</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canMeet"><label for="canMeet">üç∫ Meet for Drinks</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canAdvice"><label for="canAdvice">üí° Local Knowledge</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="canHelp"><label for="canHelp">üÜò General Help</label></div>
                </div>
                
                <div class="form-group" style="margin-top: 24px;">
                    <label>Maximum Help Radius (<span id="radiusUnit">km</span>)</label>
                    <input type="number" class="form-control" id="availRadius" value="50" style="width: 150px;">
                </div>
                
                <button class="btn btn-primary" onclick="handleSaveAvailability()">üíæ Update Availability</button>
                <div id="availResult" style="margin-top: 16px;"></div>
            </div>
        </div>
        
        <!-- Find Helpers Tab with Map -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>üó∫Ô∏è Find Nearby Helpers</h3>
                
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div>
                        <button class="btn btn-secondary" onclick="getSearchLocation()" style="margin-bottom: 12px;">üìç Use Current Location</button>
                        <div class="grid-2">
                            <input type="text" class="form-control" id="searchLat" placeholder="Latitude">
                            <input type="text" class="form-control" id="searchLng" placeholder="Longitude">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Search Radius (<span id="searchRadiusUnit">km</span>)</label>
                        <input type="number" class="form-control" id="searchRadius" value="50">
                    </div>
                </div>
                
                <div class="checkbox-group" style="margin-bottom: 20px;">
                    <div class="checkbox-item"><input type="checkbox" id="needPickup"><label>üöó Pickup</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needGarage"><label>üîß Garage</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needStay"><label>üè† Stay</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="needMeet"><label>üç∫ Meetup</label></div>
                </div>
                
                <button class="btn btn-primary" onclick="handleSearchHelpers()">üîç Search for Helpers</button>
            </div>
            
            <!-- Map -->
            <div class="map-container" style="height: 450px;">
                <div id="helpersMap"></div>
            </div>
            
            <!-- Helper List -->
            <div id="helperResults" style="margin-top: 20px;">
                <p class="loading">Use the search above to find helpers near you...</p>
            </div>
        </div>
        
        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div class="card">
                <h3>üìã Your Activity</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">
                    Track your interactions and provide feedback. Feedback is required after each completed interaction.
                </p>
                
                <div id="pendingFeedbackAlert" class="alert alert-warning hidden">
                    <strong>‚ö†Ô∏è Feedback Required:</strong> You have interactions that need feedback before you can request more help.
                </div>
                
                <h4>Pending Feedback</h4>
                <div id="pendingInteractions">
                    <p class="loading">Loading...</p>
                </div>
                
                <h4>Recent Activity</h4>
                <div id="recentActivity">
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="card">
                <h3>üö® Emergency SOS</h3>
                <div class="alert alert-warning">
                    <strong>Important:</strong> For life-threatening emergencies, always call local emergency services first (000, 111, 911, etc.)
                </div>
                
                <div class="sos-container">
                    <button class="sos-button" id="sosButton" 
                            onmousedown="startSOS()" onmouseup="cancelSOS()" onmouseleave="cancelSOS()"
                            ontouchstart="startSOS()" ontouchend="cancelSOS()">
                        üö® SOS
                        <span>Hold for 3 seconds</span>
                    </button>
                    <div class="sos-progress">
                        <div class="sos-progress-bar" id="sosProgress"></div>
                    </div>
                    <p id="sosStatus" style="margin-top: 16px; color: var(--text-light);"></p>
                </div>
            </div>
            
            <div class="card">
                <h3>üìù Create Help Request</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Type of Help</label>
                        <select class="form-control" id="sosType">
                            <option value="breakdown">üîß Breakdown</option>
                            <option value="accident">üí• Accident</option>
                            <option value="medical">üè• Medical</option>
                            <option value="stuck">üöô Stuck</option>
                            <option value="fuel">‚õΩ Out of Fuel</option>
                            <option value="unsafe">‚ö†Ô∏è Feeling Unsafe</option>
                            <option value="other">‚ùì Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Severity</label>
                        <select class="form-control" id="sosSeverity">
                            <option value="low">Low - Not urgent</option>
                            <option value="medium">Medium - Today</option>
                            <option value="high">High - Soon</option>
                            <option value="critical">Critical - Now</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="sosDescription" rows="3" placeholder="Describe your situation..."></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <button class="btn btn-secondary btn-sm" onclick="getSOSLocation()" style="margin-bottom: 8px;">üìç Get Location</button>
                    <div class="grid-2">
                        <input type="text" class="form-control" id="sosLat" placeholder="Latitude">
                        <input type="text" class="form-control" id="sosLng" placeholder="Longitude">
                    </div>
                </div>
                <button class="btn btn-danger" onclick="handleCreateSOS()">üö® Send Help Request</button>
                <div id="sosResult" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚≠ê Rate Your Interaction</h2>
                <button class="modal-close" onclick="closeFeedbackModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: var(--text-light); margin-bottom: 20px;">
                    How was your experience with <strong id="feedbackUserName">this helper</strong>?
                </p>
                
                <div class="rating-buttons">
                    <button class="rating-btn positive" onclick="selectRating('positive')">
                        <span class="emoji">üòä</span>
                        <span class="label">Positive</span>
                    </button>
                    <button class="rating-btn neutral" onclick="selectRating('neutral')">
                        <span class="emoji">üòê</span>
                        <span class="label">Neutral</span>
                    </button>
                    <button class="rating-btn negative" onclick="selectRating('negative')">
                        <span class="emoji">üòû</span>
                        <span class="label">Negative</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Comments (optional)</label>
                    <textarea class="form-control" id="feedbackComment" rows="3" placeholder="Share your experience..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="feedbackWouldAgain" checked style="margin-right: 8px;">
                        I would interact with this person again
                    </label>
                </div>
                
                <div class="form-group">
                    <label>üì∏ Verification Photo (optional)</label>
                    <p class="form-hint">Take a photo together to verify this interaction happened</p>
                    <div class="photo-upload-box" onclick="document.getElementById('photoInput').click()">
                        <span style="font-size: 32px;">üì∑</span>
                        <p>Click to upload photo</p>
                        <img id="photoPreview" class="photo-preview hidden">
                    </div>
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="previewPhoto(this)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Helper Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üì® Contact Helper</h2>
                <button class="modal-close" onclick="closeContactModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="contactHelperInfo"></div>
                
                <div class="form-group">
                    <label>What do you need help with?</label>
                    <select class="form-control" id="contactType">
                        <option value="breakdown">üîß Breakdown Assistance</option>
                        <option value="accommodation">üè† Accommodation</option>
                        <option value="meetup">üç∫ Social Meetup</option>
                        <option value="advice">üí° Local Advice</option>
                        <option value="other">‚ùì Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Message</label>
                    <textarea class="form-control" id="contactMessage" rows="4" placeholder="Hi! I'm traveling through your area and..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendContactRequest()">Send Request</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        var SUPABASE_URL = 'https://mozbpccxzfcoswvxjuym.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vemJwY2N4emZjb3N3dnhqdXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODY4NTQsImV4cCI6MjA4NDY2Mjg1NH0.lfOM5ojN2B1MV6wMsntGWmI7OWL7fhUJV5E8b6I48N0';
        
        var db = null;
        var currentUser = null;
        var userSettings = { distance: 'km', temperature: 'celsius' };
        var sosTimer = null;
        var sosStartTime = null;
        
        // Maps
        var helpersMap = null;
        var homeMap = null;
        var availMap = null;
        var markers = [];
        var currentHelpers = [];
        var selectedHelper = null;
        var currentInteractionId = null;
        var selectedRating = null;
        
        // =====================================================
        // INITIALIZATION
        // =====================================================
        window.onload = function() {
            initDatabase();
            initMaps();
        };
        
        function initDatabase() {
            try {
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                updateConnectionStatus(true);
                checkAuth();
            } catch (error) {
                console.error('Database error:', error);
                updateConnectionStatus(false);
            }
        }
        
        function initMaps() {
            // Helpers Map
            helpersMap = L.map('helpersMap').setView([-36.8485, 174.7633], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(helpersMap);
            
            // Add legend
            var legend = L.control({position: 'bottomright'});
            legend.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `
                    <div class="map-legend-item"><div class="legend-marker" style="background:#3b82f6;">üìç</div> You</div>
                    <div class="map-legend-item"><div class="legend-marker" style="background:#10b981;">üü¢</div> Available Helper</div>
                `;
                return div;
            };
            legend.addTo(helpersMap);
            
            // Home Map (smaller)
            homeMap = L.map('homeMap').setView([-36.8485, 174.7633], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM'
            }).addTo(homeMap);
            
            // Availability Map
            availMap = L.map('availMap').setView([-36.8485, 174.7633], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM'
            }).addTo(availMap);
        }
        
        function updateConnectionStatus(connected) {
            var badge = document.getElementById('connectionStatus');
            badge.textContent = connected ? 'Connected' : 'Connection Error';
            badge.className = 'status-badge ' + (connected ? 'status-connected' : 'status-disconnected');
        }
        
        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            // Refresh maps when tab becomes visible
            setTimeout(() => {
                if (tabId === 'helpers' && helpersMap) helpersMap.invalidateSize();
                if (tabId === 'profile' && homeMap) homeMap.invalidateSize();
                if (tabId === 'availability' && availMap) availMap.invalidateSize();
            }, 100);
            
            // Load activity data
            if (tabId === 'activity') loadActivity();
        }
        
        // =====================================================
        // AUTHENTICATION
        // =====================================================
        async function checkAuth() {
            if (!db) return;
            var response = await db.auth.getUser();
            if (response.data && response.data.user) {
                currentUser = response.data.user;
                document.getElementById('userArea').classList.remove('hidden');
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileEmail').value = currentUser.email;
                loadProfile();
                loadAvailability();
                checkPendingFeedback();
            }
        }
        
        async function handleSignIn() {
            var email = document.getElementById('signInEmail').value;
            var password = document.getElementById('signInPassword').value;
            var resultDiv = document.getElementById('signInResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter email and password</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">Signing in...</div>';
            var response = await db.auth.signInWithPassword({ email, password });
            
            if (response.error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå ' + response.error.message + '</div>';
            } else {
                currentUser = response.data.user;
                document.getElementById('userArea').classList.remove('hidden');
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileEmail').value = currentUser.email;
                resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ Signed in!</div>';
                loadProfile();
                loadAvailability();
                checkPendingFeedback();
            }
        }
        
        async function handleSignUp() {
            var email = document.getElementById('signUpEmail').value;
            var password = document.getElementById('signUpPassword').value;
            var displayName = document.getElementById('signUpName').value;
            var resultDiv = document.getElementById('signUpResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter email and password</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">Creating account...</div>';
            var response = await db.auth.signUp({
                email, password,
                options: { data: { display_name: displayName } }
            });
            
            if (response.error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå ' + response.error.message + '</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ Check your email to verify!</div>';
            }
        }
        
        async function handleSignOut() {
            await db.auth.signOut();
            currentUser = null;
            document.getElementById('userArea').classList.add('hidden');
        }
        
        // =====================================================
        // PROFILE
        // =====================================================
        async function loadProfile() {
            if (!db || !currentUser) return;
            var response = await db.from('profiles').select('*').eq('id', currentUser.id).single();
            
            if (response.data) {
                var d = response.data;
                document.getElementById('profileFirstName').value = d.first_name || '';
                document.getElementById('profileSurname').value = d.last_name || '';
                document.getElementById('profileKnownAs').value = d.display_name || '';
                document.getElementById('profileMobile').value = d.phone || '';
                document.getElementById('profileCountry').value = d.country || '';
                document.getElementById('profileSuburb').value = d.suburb || '';
                document.getElementById('profileCity').value = d.city || '';
                document.getElementById('profilePostCode').value = d.post_code || '';
                document.getElementById('emergencyName').value = d.emergency_contact_name || '';
                document.getElementById('emergencyPhone').value = d.emergency_contact_phone || '';
                document.getElementById('emergencyEmail').value = d.emergency_contact_email || '';
                
                if (d.home_latitude && d.home_longitude) {
                    document.getElementById('profileHomeLat').value = d.home_latitude;
                    document.getElementById('profileHomeLng').value = d.home_longitude;
                    document.getElementById('homeLocationDisplay').textContent = d.home_latitude + ', ' + d.home_longitude;
                    document.getElementById('homeLocationBox').classList.add('has-location');
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                    updateHomeMap(d.home_latitude, d.home_longitude);
                }
                
                if (d.unit_distance) selectRadio('unitDistance', d.unit_distance);
                if (d.unit_temperature) selectRadio('unitTemp', d.unit_temperature);
            }
        }
        
        async function handleSaveProfile() {
            if (!currentUser) { alert('Please sign in'); return; }
            var resultDiv = document.getElementById('profileResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            var homeLat = parseFloat(document.getElementById('profileHomeLat').value);
            var homeLng = parseFloat(document.getElementById('profileHomeLng').value);
            
            var profileData = {
                id: currentUser.id,
                first_name: document.getElementById('profileFirstName').value,
                last_name: document.getElementById('profileSurname').value,
                display_name: document.getElementById('profileKnownAs').value,
                phone: document.getElementById('profileMobile').value,
                country: document.getElementById('profileCountry').value,
                suburb: document.getElementById('profileSuburb').value,
                city: document.getElementById('profileCity').value,
                post_code: document.getElementById('profilePostCode').value,
                home_latitude: isNaN(homeLat) ? null : homeLat,
                home_longitude: isNaN(homeLng) ? null : homeLng,
                emergency_contact_name: document.getElementById('emergencyName').value,
                emergency_contact_phone: document.getElementById('emergencyPhone').value,
                emergency_contact_email: document.getElementById('emergencyEmail').value,
                unit_distance: document.querySelector('input[name="unitDistance"]:checked').value,
                unit_temperature: document.querySelector('input[name="unitTemp"]:checked').value,
                updated_at: new Date().toISOString()
            };
            
            var response = await db.from('profiles').upsert(profileData);
            resultDiv.innerHTML = response.error ? 
                '<div class="alert alert-danger">‚ùå ' + response.error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Profile saved!</div>';
        }
        
        function captureHomeGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var lat = pos.coords.latitude.toFixed(6);
                    var lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('profileHomeLat').value = lat;
                    document.getElementById('profileHomeLng').value = lng;
                    document.getElementById('homeLocationDisplay').textContent = lat + ', ' + lng;
                    document.getElementById('homeLocationBox').classList.add('has-location');
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                    updateHomeMap(parseFloat(lat), parseFloat(lng));
                }, function(err) {
                    alert('Could not get location: ' + err.message);
                    document.getElementById('manualGpsEntry').classList.remove('hidden');
                }, { enableHighAccuracy: true });
            }
        }
        
        function showManualEntry() {
            document.getElementById('manualGpsEntry').classList.toggle('hidden');
        }
        
        function updateHomeMap(lat, lng) {
            if (homeMap) {
                homeMap.setView([lat, lng], 14);
                L.marker([lat, lng]).addTo(homeMap).bindPopup('üè† Home').openPopup();
            }
        }
        
        // =====================================================
        // AVAILABILITY
        // =====================================================
        async function loadAvailability() {
            if (!currentUser) return;
            var response = await db.from('user_availability').select('*').eq('user_id', currentUser.id).single();
            
            if (response.data) {
                var d = response.data;
                document.getElementById('availActive').checked = d.is_available;
                document.getElementById('availLocation').value = d.current_location_name || '';
                document.getElementById('availRadius').value = d.max_help_radius_km || 50;
                document.getElementById('canPickup').checked = d.can_pickup;
                document.getElementById('canGarage').checked = d.can_provide_garage;
                document.getElementById('canStay').checked = d.can_provide_accommodation;
                document.getElementById('canMeet').checked = d.can_meet_for_drinks;
                document.getElementById('canAdvice').checked = d.can_provide_local_advice;
                document.getElementById('canHelp').checked = d.can_provide_help;
                
                if (d.latitude && d.longitude) {
                    document.getElementById('availLat').value = d.latitude;
                    document.getElementById('availLng').value = d.longitude;
                    if (availMap) {
                        availMap.setView([d.latitude, d.longitude], 12);
                        L.marker([d.latitude, d.longitude]).addTo(availMap);
                    }
                }
            }
        }
        
        async function handleSaveAvailability() {
            if (!currentUser) { alert('Please sign in'); return; }
            var resultDiv = document.getElementById('availResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            var lat = parseFloat(document.getElementById('availLat').value);
            var lng = parseFloat(document.getElementById('availLng').value);
            
            var data = {
                user_id: currentUser.id,
                is_available: document.getElementById('availActive').checked,
                current_location_name: document.getElementById('availLocation').value,
                latitude: isNaN(lat) ? null : lat,
                longitude: isNaN(lng) ? null : lng,
                max_help_radius_km: parseInt(document.getElementById('availRadius').value) || 50,
                can_pickup: document.getElementById('canPickup').checked,
                can_provide_garage: document.getElementById('canGarage').checked,
                can_provide_accommodation: document.getElementById('canStay').checked,
                can_meet_for_drinks: document.getElementById('canMeet').checked,
                can_provide_local_advice: document.getElementById('canAdvice').checked,
                can_provide_help: document.getElementById('canHelp').checked,
                updated_at: new Date().toISOString()
            };
            
            var response = await db.from('user_availability').upsert(data, { onConflict: 'user_id' });
            resultDiv.innerHTML = response.error ?
                '<div class="alert alert-danger">‚ùå ' + response.error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Availability updated!</div>';
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    document.getElementById('availLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('availLng').value = pos.coords.longitude.toFixed(6);
                    if (availMap) {
                        availMap.setView([pos.coords.latitude, pos.coords.longitude], 12);
                    }
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        // =====================================================
        // FIND HELPERS
        // =====================================================
        function getSearchLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    document.getElementById('searchLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('searchLng').value = pos.coords.longitude.toFixed(6);
                    helpersMap.setView([pos.coords.latitude, pos.coords.longitude], 11);
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        async function handleSearchHelpers() {
            var resultsDiv = document.getElementById('helperResults');
            resultsDiv.innerHTML = '<p class="loading">Searching...</p>';
            
            var lat = parseFloat(document.getElementById('searchLat').value);
            var lng = parseFloat(document.getElementById('searchLng').value);
            var radius = parseInt(document.getElementById('searchRadius').value) || 50;
            
            if (isNaN(lat) || isNaN(lng)) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">Please get your location first</div>';
                return;
            }
            
            // Clear existing markers
            markers.forEach(m => helpersMap.removeLayer(m));
            markers = [];
            
            // Add user marker
            var userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#3b82f6;color:white;padding:8px;border-radius:50%;font-size:16px;">üìç</div>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                })
            }).addTo(helpersMap).bindPopup('<strong>You are here</strong>');
            markers.push(userMarker);
            
            // Search helpers
            var query = db.from('user_availability')
                .select('*, profiles(id, display_name, first_name)')
                .eq('is_available', true);
            
            if (document.getElementById('needPickup').checked) query = query.eq('can_pickup', true);
            if (document.getElementById('needGarage').checked) query = query.eq('can_provide_garage', true);
            if (document.getElementById('needStay').checked) query = query.eq('can_provide_accommodation', true);
            if (document.getElementById('needMeet').checked) query = query.eq('can_meet_for_drinks', true);
            
            var response = await query;
            if (response.error) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error: ' + response.error.message + '</div>';
                return;
            }
            
            currentHelpers = (response.data || []).filter(h => {
                if (!h.latitude || !h.longitude) return false;
                h.distance = getDistance(lat, lng, h.latitude, h.longitude);
                return h.distance <= radius;
            }).sort((a, b) => a.distance - b.distance);
            
            if (currentHelpers.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">No helpers found in this area. Try increasing the radius.</div>';
                return;
            }
            
            // Add helper markers
            currentHelpers.forEach((h, i) => {
                var name = (h.profiles && h.profiles.display_name) || 'Helper';
                var marker = L.marker([h.latitude, h.longitude], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background:#10b981;color:white;padding:8px 12px;border-radius:20px;font-size:12px;white-space:nowrap;">' + name + '</div>',
                        iconAnchor: [20, 20]
                    })
                }).addTo(helpersMap);
                
                var services = [];
                if (h.can_pickup) services.push('üöó');
                if (h.can_provide_garage) services.push('üîß');
                if (h.can_provide_accommodation) services.push('üè†');
                if (h.can_meet_for_drinks) services.push('üç∫');
                
                marker.bindPopup(`
                    <strong>${name}</strong><br>
                    üìç ${h.distance.toFixed(1)} km<br>
                    ${services.join(' ')}<br>
                    <button onclick="openContactModal(${i})" style="margin-top:8px;padding:6px 12px;background:#1F4788;color:white;border:none;border-radius:4px;cursor:pointer;">Contact</button>
                `);
                markers.push(marker);
            });
            
            // Fit map to markers
            var group = L.featureGroup(markers);
            helpersMap.fitBounds(group.getBounds().pad(0.1));
            
            // Render list
            var html = '';
            currentHelpers.forEach((h, i) => {
                var name = (h.profiles && h.profiles.display_name) || 'Anonymous';
                var services = [];
                if (h.can_pickup) services.push('üöó Pickup');
                if (h.can_provide_garage) services.push('üîß Garage');
                if (h.can_provide_accommodation) services.push('üè† Stay');
                if (h.can_meet_for_drinks) services.push('üç∫ Meetup');
                if (h.can_provide_local_advice) services.push('üí° Advice');
                
                html += `
                    <div class="helper-card">
                        <h4>${name}</h4>
                        <p class="distance">üìç ${h.distance.toFixed(1)} km away - ${h.current_location_name || 'Location not specified'}</p>
                        <div class="services">${services.map(s => '<span class="service-tag">' + s + '</span>').join('')}</div>
                        <div class="actions">
                            <button class="btn btn-primary btn-sm" onclick="openContactModal(${i})">üì® Contact</button>
                            <button class="btn btn-secondary btn-sm" onclick="focusHelper(${i})">üó∫Ô∏è Show on Map</button>
                        </div>
                    </div>
                `;
            });
            resultsDiv.innerHTML = html;
        }
        
        function focusHelper(index) {
            var h = currentHelpers[index];
            helpersMap.setView([h.latitude, h.longitude], 14);
            markers[index + 1].openPopup(); // +1 because user marker is first
        }
        
        function getDistance(lat1, lng1, lat2, lng2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        // =====================================================
        // CONTACT & INTERACTIONS
        // =====================================================
        function openContactModal(index) {
            selectedHelper = currentHelpers[index];
            var name = (selectedHelper.profiles && selectedHelper.profiles.display_name) || 'Helper';
            
            document.getElementById('contactHelperInfo').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:48px;">üë§</div>
                    <h3>${name}</h3>
                    <p style="color:var(--text-light);">üìç ${selectedHelper.distance.toFixed(1)} km away</p>
                </div>
            `;
            
            document.getElementById('contactModal').classList.add('active');
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            selectedHelper = null;
        }
        
        async function sendContactRequest() {
            if (!currentUser || !selectedHelper) return;
            
            // Create interaction record
            var response = await db.from('interactions').insert({
                requester_id: currentUser.id,
                helper_id: selectedHelper.profiles.id,
                interaction_type: document.getElementById('contactType').value,
                status: 'pending',
                notes: document.getElementById('contactMessage').value
            });
            
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                alert('‚úÖ Request sent! The helper will be notified.');
                closeContactModal();
            }
        }
        
        // =====================================================
        // ACTIVITY & FEEDBACK
        // =====================================================
        async function checkPendingFeedback() {
            if (!currentUser) return;
            
            var response = await db.from('interactions')
                .select('*')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .eq('status', 'completed')
                .or(`and(requester_id.eq.${currentUser.id},requester_feedback_given.eq.false),and(helper_id.eq.${currentUser.id},helper_feedback_given.eq.false)`);
            
            var pendingCount = response.data ? response.data.length : 0;
            var badge = document.getElementById('pendingFeedback');
            
            if (pendingCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = '‚ö†Ô∏è ' + pendingCount + ' Feedback Required';
            } else {
                badge.classList.add('hidden');
            }
        }
        
        async function loadActivity() {
            if (!currentUser) return;
            
            // Load pending feedback
            var pendingResponse = await db.from('interactions')
                .select('*, requester:requester_id(display_name), helper:helper_id(display_name)')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .eq('status', 'completed');
            
            var pendingDiv = document.getElementById('pendingInteractions');
            var pending = (pendingResponse.data || []).filter(i => {
                if (i.requester_id === currentUser.id && !i.requester_feedback_given) return true;
                if (i.helper_id === currentUser.id && !i.helper_feedback_given) return true;
                return false;
            });
            
            if (pending.length > 0) {
                document.getElementById('pendingFeedbackAlert').classList.remove('hidden');
                pendingDiv.innerHTML = pending.map(i => {
                    var otherUser = i.requester_id === currentUser.id ? i.helper : i.requester;
                    var name = otherUser ? otherUser.display_name : 'Unknown';
                    return `
                        <div class="interaction-card needs-feedback">
                            <div class="interaction-header">
                                <span class="interaction-type">${i.interaction_type}</span>
                                <span class="interaction-status status-needs-feedback">Feedback Required</span>
                            </div>
                            <p><strong>With:</strong> ${name}</p>
                            <p><strong>Date:</strong> ${new Date(i.completed_at || i.created_at).toLocaleDateString()}</p>
                            <button class="btn btn-warning btn-sm" onclick="openFeedbackModal('${i.id}', '${name}')" style="margin-top:12px;">‚≠ê Give Feedback</button>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('pendingFeedbackAlert').classList.add('hidden');
                pendingDiv.innerHTML = '<p style="color:var(--text-light);">No pending feedback üéâ</p>';
            }
            
            // Load recent activity
            var recentResponse = await db.from('interactions')
                .select('*, requester:requester_id(display_name), helper:helper_id(display_name)')
                .or(`requester_id.eq.${currentUser.id},helper_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false })
                .limit(10);
            
            var recentDiv = document.getElementById('recentActivity');
            var recent = recentResponse.data || [];
            
            if (recent.length > 0) {
                recentDiv.innerHTML = recent.map(i => {
                    var otherUser = i.requester_id === currentUser.id ? i.helper : i.requester;
                    var name = otherUser ? otherUser.display_name : 'Unknown';
                    var statusClass = i.status === 'completed' ? 'status-completed' : 'status-pending';
                    return `
                        <div class="interaction-card">
                            <div class="interaction-header">
                                <span class="interaction-type">${i.interaction_type}</span>
                                <span class="interaction-status ${statusClass}">${i.status}</span>
                            </div>
                            <p><strong>With:</strong> ${name}</p>
                            <p><strong>Date:</strong> ${new Date(i.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }).join('');
            } else {
                recentDiv.innerHTML = '<p style="color:var(--text-light);">No activity yet. Start by finding helpers!</p>';
            }
        }
        
        // =====================================================
        // FEEDBACK MODAL
        // =====================================================
        function openFeedbackModal(interactionId, userName) {
            currentInteractionId = interactionId;
            selectedRating = null;
            document.getElementById('feedbackUserName').textContent = userName;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('feedbackComment').value = '';
            document.getElementById('feedbackWouldAgain').checked = true;
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('feedbackModal').classList.add('active');
        }
        
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            currentInteractionId = null;
        }
        
        function selectRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('.rating-btn.' + rating).classList.add('selected');
        }
        
        function previewPhoto(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function submitFeedback() {
            if (!selectedRating) {
                alert('Please select a rating');
                return;
            }
            
            // Get interaction details
            var interactionRes = await db.from('interactions').select('*').eq('id', currentInteractionId).single();
            if (!interactionRes.data) {
                alert('Error loading interaction');
                return;
            }
            
            var interaction = interactionRes.data;
            var isRequester = interaction.requester_id === currentUser.id;
            var toUserId = isRequester ? interaction.helper_id : interaction.requester_id;
            
            // Insert feedback
            var feedbackResponse = await db.from('feedback').insert({
                interaction_id: currentInteractionId,
                from_user_id: currentUser.id,
                to_user_id: toUserId,
                rating: selectedRating,
                comment: document.getElementById('feedbackComment').value,
                would_interact_again: document.getElementById('feedbackWouldAgain').checked,
                interaction_type: interaction.interaction_type
            });
            
            if (feedbackResponse.error) {
                alert('Error: ' + feedbackResponse.error.message);
                return;
            }
            
            // Update interaction
            var updateField = isRequester ? 'requester_feedback_given' : 'helper_feedback_given';
            await db.from('interactions').update({ [updateField]: true }).eq('id', currentInteractionId);
            
            closeFeedbackModal();
            checkPendingFeedback();
            loadActivity();
            alert('‚úÖ Thank you for your feedback!');
        }
        
        // =====================================================
        // SOS
        // =====================================================
        function getSOSLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    document.getElementById('sosLat').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('sosLng').value = pos.coords.longitude.toFixed(6);
                }, err => alert('Error: ' + err.message), { enableHighAccuracy: true });
            }
        }
        
        function startSOS() {
            var btn = document.getElementById('sosButton');
            var progress = document.getElementById('sosProgress');
            btn.classList.add('holding');
            sosStartTime = Date.now();
            document.getElementById('sosStatus').textContent = 'Hold for 3 seconds...';
            
            sosTimer = setInterval(function() {
                var elapsed = Date.now() - sosStartTime;
                progress.style.width = Math.min((elapsed / 3000) * 100, 100) + '%';
                if (elapsed >= 3000) {
                    cancelSOS();
                    triggerSOS();
                }
            }, 50);
        }
        
        function cancelSOS() {
            document.getElementById('sosButton').classList.remove('holding');
            document.getElementById('sosProgress').style.width = '0%';
            if (sosTimer) { clearInterval(sosTimer); sosTimer = null; }
        }
        
        function triggerSOS() {
            document.getElementById('sosStatus').textContent = 'üö® SOS TRIGGERED!';
            document.getElementById('sosStatus').style.color = 'var(--danger)';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function(pos) {
                    await db.from('sos_alerts').insert({
                        user_id: currentUser.id,
                        alert_type: 'emergency',
                        severity: 'critical',
                        description: 'EMERGENCY SOS',
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        status: 'active'
                    });
                    document.getElementById('sosStatus').textContent = '‚úÖ SOS sent!';
                });
            }
        }
        
        async function handleCreateSOS() {
            if (!currentUser) { alert('Please sign in'); return; }
            var resultDiv = document.getElementById('sosResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Sending...</div>';
            
            var response = await db.from('sos_alerts').insert({
                user_id: currentUser.id,
                alert_type: document.getElementById('sosType').value,
                severity: document.getElementById('sosSeverity').value,
                description: document.getElementById('sosDescription').value,
                latitude: parseFloat(document.getElementById('sosLat').value) || null,
                longitude: parseFloat(document.getElementById('sosLng').value) || null,
                status: 'active'
            });
            
            resultDiv.innerHTML = response.error ?
                '<div class="alert alert-danger">‚ùå ' + response.error.message + '</div>' :
                '<div class="alert alert-success">‚úÖ Help request sent!</div>';
        }
        
        // =====================================================
        // UTILITIES
        // =====================================================
        function selectRadio(name, value) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                r.checked = r.value === value;
                r.closest('.radio-item').classList.toggle('selected', r.checked);
            });
        }
    </script>
</body>
</html>
