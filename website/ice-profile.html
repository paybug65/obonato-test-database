<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE Profile ‚Äî Tiriwe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="js/tiriwe-core.js"></script>
    <style>
        :root {
            --green: #2E7D32;
            --green-light: #43A047;
            --green-dark: #1B5E20;
            --green-pale: #E8F5E9;
            --orange: #FF9800;
            --orange-pale: #FFF3E0;
            --red: #F44336;
            --red-pale: #FFEBEE;
            --blue: #1976D2;
            --blue-pale: #E3F2FD;
            --purple: #7B1FA2;
            --purple-pale: #F3E5F5;
            --white: #ffffff;
            --off-white: #f8fafc;
            --text: #1e293b;
            --text-mid: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text); background: var(--off-white); line-height: 1.6;
        }

        /* ===== LAYOUT ===== */
        .page-container {
            max-width: 720px; margin: 0 auto;
            padding: 32px 24px 80px;
        }

        .page-header { margin-bottom: 8px; }
        .page-header h1 { font-size: 28px; font-weight: 800; }
        .page-header p { color: var(--text-mid); font-size: 15px; margin-top: 4px; }
        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--text-muted); text-decoration: none; font-size: 13px;
            font-weight: 500; margin-bottom: 16px; transition: color 0.2s;
        }
        .back-link:hover { color: var(--green); }

        /* ===== PRIVACY EXPLAINER ===== */
        .privacy-explainer {
            background: var(--blue-pale); border: 1px solid #BBDEFB;
            border-radius: var(--radius); padding: 16px 20px;
            margin-bottom: 24px; font-size: 13px; color: #0D47A1;
            display: flex; gap: 12px; align-items: start;
        }
        .privacy-explainer-icon { font-size: 20px; flex-shrink: 0; }
        .privacy-explainer strong { display: block; font-size: 14px; margin-bottom: 4px; }

        /* ===== SECTIONS ===== */
        .ice-section {
            background: white; border-radius: var(--radius);
            border: 1px solid var(--border); margin-bottom: 24px;
            overflow: hidden;
        }
        .section-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px;
        }
        .section-header-icon { font-size: 20px; }
        .section-header h2 { font-size: 16px; font-weight: 700; }
        .section-header .section-badge {
            font-size: 11px; font-weight: 600; padding: 2px 8px;
            border-radius: 4px; margin-left: auto;
        }
        .badge-sensitive { background: var(--red-pale); color: #C62828; }
        .badge-encrypted { background: var(--purple-pale); color: var(--purple); }
        .section-body { padding: 24px; }

        /* ===== FORM ===== */
        .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 20px;
        }
        .form-row.full { grid-template-columns: 1fr; }
        .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 600;
            color: var(--text-mid); margin-bottom: 6px;
        }
        .form-group label .hint {
            font-weight: 400; color: var(--text-muted);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%; padding: 10px 14px; border: 1.5px solid var(--border);
            border-radius: 8px; font-family: inherit; font-size: 14px;
            transition: all 0.2s; background: var(--off-white);
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none; border-color: var(--green);
            background: white; box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
        }
        .form-group textarea { resize: vertical; min-height: 70px; }

        /* ===== VISIBILITY CONTROL ===== */
        .field-with-visibility {
            display: flex; gap: 12px; align-items: end;
        }
        .field-with-visibility .form-group:first-child { flex: 1; }
        .visibility-select {
            width: 160px; flex-shrink: 0;
        }
        .visibility-select label {
            display: block; font-size: 11px; font-weight: 600;
            color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .visibility-select select {
            width: 100%; padding: 10px 10px; border: 1.5px solid var(--border);
            border-radius: 8px; font-family: inherit; font-size: 12px;
            background: var(--off-white); color: var(--text-mid);
        }
        .visibility-select select:focus {
            outline: none; border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
        }

        /* Visibility legend */
        .visibility-legend {
            display: flex; gap: 16px; flex-wrap: wrap;
            font-size: 11px; color: var(--text-muted); margin-bottom: 20px;
        }
        .visibility-legend span {
            display: flex; align-items: center; gap: 4px;
        }
        .vis-dot {
            width: 8px; height: 8px; border-radius: 50%;
        }
        .vis-dot.only-me { background: var(--purple); }
        .vis-dot.ec { background: var(--orange); }
        .vis-dot.helpers { background: var(--green); }
        .vis-dot.verified { background: var(--blue); }

        /* ===== EXPIRY FIELDS ===== */
        .expiry-warning {
            font-size: 12px; font-weight: 600; padding: 4px 8px;
            border-radius: 4px; margin-top: 6px; display: none;
        }
        .expiry-warning.expired { display: inline-block; background: var(--red-pale); color: #C62828; }
        .expiry-warning.soon { display: inline-block; background: var(--orange-pale); color: #E65100; }

        /* ===== EMERGENCY CONTACTS ===== */
        .ec-list { margin-bottom: 16px; }
        .ec-card {
            display: flex; align-items: center; gap: 16px;
            padding: 16px; background: var(--off-white);
            border-radius: 8px; border: 1px solid var(--border);
            margin-bottom: 8px;
        }
        .ec-card-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--orange-pale); display: flex; align-items: center;
            justify-content: center; font-size: 18px; flex-shrink: 0;
        }
        .ec-card-info { flex: 1; }
        .ec-card-name { font-weight: 600; font-size: 14px; }
        .ec-card-detail { font-size: 12px; color: var(--text-muted); }
        .ec-card-actions { display: flex; gap: 8px; }
        .ec-card-actions button {
            padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border);
            background: white; cursor: pointer; font-size: 12px; font-family: inherit;
            transition: all 0.2s;
        }
        .ec-card-actions button:hover { border-color: var(--text-muted); }
        .ec-card-actions button.delete:hover { border-color: var(--red); color: var(--red); background: var(--red-pale); }

        .ec-empty {
            text-align: center; padding: 24px; color: var(--text-muted);
            font-size: 14px;
        }

        /* Add contact form (hidden by default) */
        .ec-add-form {
            display: none; padding: 20px; background: var(--green-pale);
            border-radius: 8px; margin-bottom: 16px; border: 1px solid #C8E6C9;
        }
        .ec-add-form.visible { display: block; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 24px; border-radius: 8px; font-family: inherit;
            font-size: 14px; font-weight: 600; cursor: pointer;
            border: none; transition: all 0.2s; display: inline-flex;
            align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-primary:disabled { background: #A5D6A7; cursor: not-allowed; }
        .btn-secondary { background: var(--off-white); color: var(--text-mid); border: 1.5px solid var(--border); }
        .btn-secondary:hover { background: white; border-color: var(--text-muted); }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-large { padding: 14px 32px; font-size: 16px; }

        .save-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px;
        }
        .save-status {
            font-size: 13px; color: var(--green); font-weight: 500;
            opacity: 0; transition: opacity 0.3s;
        }
        .save-status.visible { opacity: 1; }

        /* ===== LOADING ===== */
        .loading-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: 60vh; flex-direction: column; gap: 16px;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--green); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-muted); font-size: 14px; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 600px) {
            .form-row, .form-row.triple { grid-template-columns: 1fr; }
            .field-with-visibility { flex-direction: column; }
            .visibility-select { width: 100%; }
            .page-container { padding: 16px 16px 80px; }
        }
    </style>
</head>
<body>

<nav id="tiriwe-nav"></nav>

<!-- Loading -->
<div class="page-container" id="loading-screen">
    <div class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading your ICE profile...</div>
    </div>
</div>

<!-- Main content -->
<div class="page-container" id="main-content" style="display:none;">

    <a href="settings.html" class="back-link">‚Üê Back to Settings</a>

    <div class="page-header">
        <h1>üè• ICE Profile</h1>
        <p>In Case of Emergency ‚Äî medical info, travel documents, and emergency contacts.</p>
    </div>

    <!-- Privacy explainer -->
    <div class="privacy-explainer">
        <span class="privacy-explainer-icon">üîí</span>
        <div>
            <strong>You control who sees each field</strong>
            Every field has a visibility setting. Choose who can access your sensitive information. Fields marked "Only Me" are never shared ‚Äî they're here so you have them in one place when you need them.
        </div>
    </div>

    <!-- Visibility legend -->
    <div class="visibility-legend">
        <span><span class="vis-dot only-me"></span> Only Me</span>
        <span><span class="vis-dot ec"></span> Emergency Contacts</span>
        <span><span class="vis-dot helpers"></span> Confirmed Helpers (during SOS)</span>
        <span><span class="vis-dot verified"></span> All Verified Users</span>
    </div>

    <!-- ===== MEDICAL ===== -->
    <div class="ice-section">
        <div class="section-header">
            <span class="section-header-icon">‚ù§Ô∏è</span>
            <h2>Medical Information</h2>
            <span class="section-badge badge-sensitive">Sensitive</span>
        </div>
        <div class="section-body">
            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Blood Type</label>
                    <select id="blood_type">
                        <option value="">Not set</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_blood_type">
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="only_me">Only Me</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Allergies <span class="hint">(medications, food, insect stings, etc.)</span></label>
                    <textarea id="allergies" placeholder="e.g. Penicillin, bee stings, peanuts" rows="2"></textarea>
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_allergies">
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="only_me">Only Me</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Current Medications</label>
                    <textarea id="medications" placeholder="e.g. Metformin 500mg twice daily, Ventolin inhaler as needed" rows="2"></textarea>
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_medications">
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="only_me">Only Me</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Medical Conditions <span class="hint">(diabetes, epilepsy, asthma, etc.)</span></label>
                    <textarea id="medical_conditions" placeholder="e.g. Type 2 diabetes, asthma" rows="2"></textarea>
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_medical_conditions">
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="only_me">Only Me</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Medical Notes <span class="hint">(anything else a responder should know)</span></label>
                    <textarea id="medical_notes" placeholder="e.g. Wears medical alert bracelet, EpiPen in left pannier" rows="2"></textarea>
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_medical_notes">
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="only_me">Only Me</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TRAVEL DOCUMENTS ===== -->
    <div class="ice-section">
        <div class="section-header">
            <span class="section-header-icon">üõÇ</span>
            <h2>Travel Documents</h2>
            <span class="section-badge badge-encrypted">Private</span>
        </div>
        <div class="section-body">

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Nationality / Country of Citizenship</label>
                    <input type="text" id="nationality" placeholder="e.g. New Zealand">
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_nationality">
                        <option value="only_me">Only Me</option>
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                        <option value="verified">All Verified Users</option>
                    </select>
                </div>
            </div>

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Passport Number</label>
                    <input type="text" id="passport_number" placeholder="e.g. LN123456">
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_passport_number">
                        <option value="only_me">Only Me</option>
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Passport Expiry Date</label>
                    <input type="date" id="passport_expiry">
                    <div class="expiry-warning" id="passport-expiry-warning"></div>
                </div>
                <div class="form-group">
                    <label>Passport Issuing Country</label>
                    <input type="text" id="passport_country" placeholder="e.g. New Zealand">
                </div>
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin: 20px 0;">

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Visa Type <span class="hint">(if traveling on a visa)</span></label>
                    <input type="text" id="visa_type" placeholder="e.g. Working Holiday, Tourist, Student">
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_visa">
                        <option value="only_me">Only Me</option>
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Visa Expiry Date</label>
                    <input type="date" id="visa_expiry">
                    <div class="expiry-warning" id="visa-expiry-warning"></div>
                </div>
                <div class="form-group">
                    <label>Visa Country</label>
                    <input type="text" id="visa_country" placeholder="e.g. Australia">
                </div>
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin: 20px 0;">

            <div class="field-with-visibility">
                <div class="form-group">
                    <label>Travel Insurance Provider</label>
                    <input type="text" id="insurance_provider" placeholder="e.g. World Nomads, Southern Cross">
                </div>
                <div class="visibility-select">
                    <label>Who can see</label>
                    <select id="vis_insurance">
                        <option value="only_me">Only Me</option>
                        <option value="emergency_contacts">Emergency Contacts</option>
                        <option value="helpers">Confirmed Helpers</option>
                    </select>
                </div>
            </div>

            <div class="form-row triple">
                <div class="form-group">
                    <label>Policy Number</label>
                    <input type="text" id="insurance_policy" placeholder="e.g. WN-12345678">
                </div>
                <div class="form-group">
                    <label>Emergency Phone</label>
                    <input type="tel" id="insurance_phone" placeholder="e.g. +64 800 123 456">
                </div>
                <div class="form-group">
                    <label>Expiry Date</label>
                    <input type="date" id="insurance_expiry">
                    <div class="expiry-warning" id="insurance-expiry-warning"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== EMERGENCY CONTACTS ===== -->
    <div class="ice-section">
        <div class="section-header">
            <span class="section-header-icon">üìû</span>
            <h2>Emergency Contacts</h2>
        </div>
        <div class="section-body">
            <p style="font-size:13px; color:var(--text-muted); margin-bottom:16px;">
                These people will be notified if you trigger an Emergency SOS or if a helper flags you as hospitalised.
            </p>

            <!-- Contact list -->
            <div class="ec-list" id="ec-list">
                <div class="ec-empty" id="ec-empty">
                    No emergency contacts added yet. Add at least one ‚Äî it could save your life.
                </div>
            </div>

            <!-- Add contact form (toggled) -->
            <div class="ec-add-form" id="ec-add-form">
                <div style="font-weight:700; font-size:14px; margin-bottom:12px;">Add Emergency Contact</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="ec_name" placeholder="e.g. Mum">
                    </div>
                    <div class="form-group">
                        <label>Relationship</label>
                        <select id="ec_relationship">
                            <option value="family">Family</option>
                            <option value="partner">Partner</option>
                            <option value="friend">Friend</option>
                            <option value="travel_buddy">Travel Buddy</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="ec_phone" placeholder="+64 21 123 4567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="ec_email" placeholder="mum@email.com">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Contact Type</label>
                        <select id="ec_contact_type">
                            <option value="home">Home Country</option>
                            <option value="local">Local (in-country)</option>
                            <option value="travel_buddy">Travel Buddy</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" style="display:flex; align-items:end;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="ec_auto_notify" checked style="width:auto;"> 
                            Auto-notify on SOS
                        </label>
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn btn-primary btn-small" onclick="saveEmergencyContact()">Save Contact</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleAddForm()">Cancel</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="btn-add-ec" onclick="toggleAddForm()">
                ‚ûï Add Emergency Contact
            </button>
        </div>
    </div>

    <!-- ===== SAVE BAR ===== -->
    <div class="save-bar">
        <span class="save-status" id="save-status">‚úÖ ICE profile saved</span>
        <button class="btn btn-primary btn-large" id="btn-save" onclick="saveICEProfile()">
            Save ICE Profile
        </button>
    </div>

</div>

<script>
    // ====================================================================
    // ICE PROFILE PAGE LOGIC
    // ====================================================================

    let emergencyContacts = [];

    Tiriwe.ready().then(() => {
        const user = Tiriwe.user;
        if (!user) return;

        populateICE(user);
        loadEmergencyContacts(user.id);
        setupExpiryChecks();

        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
    });

    /**
     * Populate medical & travel doc fields from user metadata
     */
    function populateICE(user) {
        const ice = (user.metadata && user.metadata.ice) || {};

        // Medical
        document.getElementById('blood_type').value = ice.blood_type || '';
        document.getElementById('allergies').value = ice.allergies || '';
        document.getElementById('medications').value = ice.medications || '';
        document.getElementById('medical_conditions').value = ice.medical_conditions || '';
        document.getElementById('medical_notes').value = ice.medical_notes || '';

        // Travel docs
        document.getElementById('nationality').value = ice.nationality || '';
        document.getElementById('passport_number').value = ice.passport_number || '';
        document.getElementById('passport_expiry').value = ice.passport_expiry || '';
        document.getElementById('passport_country').value = ice.passport_country || '';
        document.getElementById('visa_type').value = ice.visa_type || '';
        document.getElementById('visa_expiry').value = ice.visa_expiry || '';
        document.getElementById('visa_country').value = ice.visa_country || '';
        document.getElementById('insurance_provider').value = ice.insurance_provider || '';
        document.getElementById('insurance_policy').value = ice.insurance_policy || '';
        document.getElementById('insurance_phone').value = ice.insurance_phone || '';
        document.getElementById('insurance_expiry').value = ice.insurance_expiry || '';

        // Visibility settings
        const vis = (user.metadata && user.metadata.ice_visibility) || {};
        const visFields = [
            'vis_blood_type', 'vis_allergies', 'vis_medications', 'vis_medical_conditions',
            'vis_medical_notes', 'vis_nationality', 'vis_passport_number', 'vis_visa',
            'vis_insurance'
        ];
        visFields.forEach(id => {
            const el = document.getElementById(id);
            if (el && vis[id]) el.value = vis[id];
        });
    }

    /**
     * Save medical & travel doc info to user metadata
     */
    async function saveICEProfile() {
        const btn = document.getElementById('btn-save');
        const status = document.getElementById('save-status');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        status.classList.remove('visible');

        const user = Tiriwe.user;
        if (!user) return;

        const ice = {
            blood_type: document.getElementById('blood_type').value,
            allergies: document.getElementById('allergies').value.trim(),
            medications: document.getElementById('medications').value.trim(),
            medical_conditions: document.getElementById('medical_conditions').value.trim(),
            medical_notes: document.getElementById('medical_notes').value.trim(),
            nationality: document.getElementById('nationality').value.trim(),
            passport_number: document.getElementById('passport_number').value.trim(),
            passport_expiry: document.getElementById('passport_expiry').value,
            passport_country: document.getElementById('passport_country').value.trim(),
            visa_type: document.getElementById('visa_type').value.trim(),
            visa_expiry: document.getElementById('visa_expiry').value,
            visa_country: document.getElementById('visa_country').value.trim(),
            insurance_provider: document.getElementById('insurance_provider').value.trim(),
            insurance_policy: document.getElementById('insurance_policy').value.trim(),
            insurance_phone: document.getElementById('insurance_phone').value.trim(),
            insurance_expiry: document.getElementById('insurance_expiry').value,
        };

        const ice_visibility = {};
        ['vis_blood_type', 'vis_allergies', 'vis_medications', 'vis_medical_conditions',
         'vis_medical_notes', 'vis_nationality', 'vis_passport_number', 'vis_visa',
         'vis_insurance'].forEach(id => {
            ice_visibility[id] = document.getElementById(id).value;
        });

        // Merge with existing metadata
        const existingMeta = user.metadata || {};
        const updatedMeta = {
            ...existingMeta,
            ice: ice,
            ice_visibility: ice_visibility,
        };

        const { error } = await Tiriwe.sb
            .from('users')
            .update({ metadata: updatedMeta, updated_at: new Date().toISOString() })
            .eq('id', user.id);

        if (error) {
            console.error('‚ùå Save failed:', error);
            Tiriwe.showToast('Failed to save: ' + error.message, 'error');
            btn.disabled = false;
            btn.textContent = 'Save ICE Profile';
            return;
        }

        Tiriwe.showToast('ICE profile saved', 'success');
        status.textContent = '‚úÖ ICE profile saved';
        status.classList.add('visible');
        btn.disabled = false;
        btn.textContent = 'Save ICE Profile';
        setTimeout(() => { status.classList.remove('visible'); }, 3000);
    }

    // ====================================================================
    // EMERGENCY CONTACTS (uses emergency_contacts table)
    // ====================================================================

    async function loadEmergencyContacts(userId) {
        const { data, error } = await Tiriwe.sb
            .from('emergency_contacts')
            .select('*')
            .eq('user_id', userId)
            .is('deleted_at', null)
            .order('created_at', { ascending: true });

        if (error) {
            console.warn('Could not load emergency contacts:', error.message);
            return;
        }

        emergencyContacts = data || [];
        renderEmergencyContacts();
    }

    function renderEmergencyContacts() {
        const list = document.getElementById('ec-list');
        const empty = document.getElementById('ec-empty');

        // Clear existing cards (keep empty message)
        list.querySelectorAll('.ec-card').forEach(c => c.remove());

        if (emergencyContacts.length === 0) {
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';

        emergencyContacts.forEach(ec => {
            const card = document.createElement('div');
            card.className = 'ec-card';
            card.innerHTML = `
                <div class="ec-card-icon">üë§</div>
                <div class="ec-card-info">
                    <div class="ec-card-name">${escapeHtml(ec.contact_name || 'Unnamed')}</div>
                    <div class="ec-card-detail">
                        ${escapeHtml(ec.relationship || '')} ¬∑ ${escapeHtml(ec.phone || ec.email || 'No contact info')}
                        ${ec.auto_notify_on_sos ? ' ¬∑ üîî Auto-notify' : ''}
                    </div>
                </div>
                <div class="ec-card-actions">
                    <button class="delete" onclick="deleteEmergencyContact('${ec.id}')">Remove</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function toggleAddForm() {
        const form = document.getElementById('ec-add-form');
        const btn = document.getElementById('btn-add-ec');
        form.classList.toggle('visible');
        btn.style.display = form.classList.contains('visible') ? 'none' : 'inline-flex';
    }

    async function saveEmergencyContact() {
        const user = Tiriwe.user;
        if (!user) return;

        const name = document.getElementById('ec_name').value.trim();
        const phone = document.getElementById('ec_phone').value.trim();
        const email = document.getElementById('ec_email').value.trim();

        if (!name) {
            Tiriwe.showToast('Please enter a name', 'error');
            return;
        }
        if (!phone && !email) {
            Tiriwe.showToast('Please enter a phone number or email', 'error');
            return;
        }

        const contact = {
            user_id: user.id,
            contact_name: name,
            relationship: document.getElementById('ec_relationship').value,
            phone: phone || null,
            email: email || null,
            contact_type: document.getElementById('ec_contact_type').value,
            auto_notify_on_sos: document.getElementById('ec_auto_notify').checked,
        };

        const { data, error } = await Tiriwe.sb
            .from('emergency_contacts')
            .insert(contact)
            .select()
            .single();

        if (error) {
            console.error('‚ùå Failed to save contact:', error);
            Tiriwe.showToast('Failed to save: ' + error.message, 'error');
            return;
        }

        emergencyContacts.push(data);
        renderEmergencyContacts();
        toggleAddForm();
        Tiriwe.showToast('Emergency contact added', 'success');

        // Clear form
        document.getElementById('ec_name').value = '';
        document.getElementById('ec_phone').value = '';
        document.getElementById('ec_email').value = '';
    }

    async function deleteEmergencyContact(contactId) {
        if (!confirm('Remove this emergency contact?')) return;

        const { error } = await Tiriwe.sb
            .from('emergency_contacts')
            .update({ deleted_at: new Date().toISOString() })
            .eq('id', contactId);

        if (error) {
            Tiriwe.showToast('Failed to remove: ' + error.message, 'error');
            return;
        }

        emergencyContacts = emergencyContacts.filter(ec => ec.id !== contactId);
        renderEmergencyContacts();
        Tiriwe.showToast('Contact removed', 'success');
    }

    // ====================================================================
    // EXPIRY DATE CHECKS
    // ====================================================================

    function setupExpiryChecks() {
        const expiryFields = [
            { input: 'passport_expiry', warning: 'passport-expiry-warning', label: 'Passport' },
            { input: 'visa_expiry', warning: 'visa-expiry-warning', label: 'Visa' },
            { input: 'insurance_expiry', warning: 'insurance-expiry-warning', label: 'Insurance' },
        ];

        expiryFields.forEach(({ input, warning, label }) => {
            const el = document.getElementById(input);
            const warn = document.getElementById(warning);

            const check = () => {
                if (!el.value) { warn.style.display = 'none'; return; }
                const expiry = new Date(el.value);
                const now = new Date();
                const daysUntil = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

                if (daysUntil < 0) {
                    warn.textContent = `‚ö†Ô∏è ${label} expired ${Math.abs(daysUntil)} days ago`;
                    warn.className = 'expiry-warning expired';
                } else if (daysUntil < 90) {
                    warn.textContent = `‚è∞ ${label} expires in ${daysUntil} days`;
                    warn.className = 'expiry-warning soon';
                } else {
                    warn.style.display = 'none';
                }
            };

            el.addEventListener('change', check);
            check(); // Check on load
        });
    }

    // ====================================================================
    // UTILITIES
    // ====================================================================

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
</script>

</body>
</html>
