<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obonato Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #7c3aed;
            --primary-dark: #5b21b6;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-light: #94a3b8;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }
        
        .logo h1 { font-size: 22px; font-weight: 700; color: white; }
        .logo span { font-size: 11px; opacity: 0.8; color: white; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 12px 12px 0 0;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab:hover { color: var(--text); background: var(--bg-hover); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        .tab-content {
            display: none;
            background: var(--bg-card);
            padding: 30px;
            border-radius: 0 0 12px 12px;
            min-height: 600px;
        }
        .tab-content.active { display: block; }
        
        .card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-card .label {
            color: var(--text-light);
            font-size: 14px;
            margin-top: 8px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }
        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .alert-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); }
        .alert-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .alert-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
        .alert-info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-hover); font-weight: 600; font-size: 13px; color: var(--text-light); }
        tr:hover { background: var(--bg-hover); }
        
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        
        @media (max-width: 768px) {
            .tabs { flex-wrap: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>üîê Obonato Admin</h1>
                <span>Database Management Portal</span>
            </div>
            <div class="header-right">
                <span id="connectionStatus" class="status-badge status-disconnected">Not Connected</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('settings', this)">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab" onclick="showTab('users', this)">üë• Users</button>
            <button class="tab" onclick="showTab('helpers', this)">ü§ù Helpers</button>
            <button class="tab" onclick="showTab('sos', this)">üö® SOS Alerts</button>
            <button class="tab" onclick="showTab('feedback', this)">‚≠ê Feedback</button>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content active">
            <div class="card">
                <h3>‚öôÔ∏è Database Connection</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Admin Portal:</strong> Use your <strong>service_role</strong> key here for full database access. This key bypasses Row Level Security - keep it secret!
                </div>
                
                <div class="form-group">
                    <label>Supabase Project URL</label>
                    <input type="text" class="form-control" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                </div>
                
                <div class="form-group">
                    <label>Supabase Service Role Key</label>
                    <input type="password" class="form-control" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    <div class="form-hint">Found in Settings ‚Üí API ‚Üí service_role (secret)</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="handleTestConnection()">üîç Test Connection</button>
                    <button class="btn btn-success" onclick="handleSaveConnection()">üíæ Save & Connect</button>
                    <button class="btn btn-secondary" onclick="handleClearConnection()">üóëÔ∏è Clear</button>
                </div>
                
                <div id="connectionResult" style="margin-top: 20px;"></div>
            </div>
            
            <div class="card">
                <h3>üìä Database Tables</h3>
                <div id="tableStatus">
                    <p class="loading">Connect to see table status...</p>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="statUsers">-</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statHelpers">-</div>
                    <div class="label">Active Helpers</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statSOS">-</div>
                    <div class="label">Active SOS</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="statFeedback">-</div>
                    <div class="label">Feedback Given</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Recent Activity</h3>
                <div id="recentActivity">
                    <p class="loading">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="card">
                <h3>üë• User Management</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh Users</button>
                </div>
                <div id="usersList">
                    <p class="loading">Click refresh to load users...</p>
                </div>
            </div>
        </div>
        
        <!-- Helpers Tab -->
        <div id="helpers" class="tab-content">
            <div class="card">
                <h3>ü§ù Helper Availability</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadHelpers()">üîÑ Refresh</button>
                </div>
                <div id="helpersList">
                    <p class="loading">Click refresh to load helpers...</p>
                </div>
            </div>
        </div>
        
        <!-- SOS Tab -->
        <div id="sos" class="tab-content">
            <div class="card">
                <h3>üö® SOS Alerts</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadSOSAlerts()">üîÑ Refresh</button>
                    <button class="btn btn-danger" onclick="createTestSOS()">‚ûï Create Test SOS</button>
                </div>
                <div id="sosList">
                    <p class="loading">Click refresh to load alerts...</p>
                </div>
            </div>
        </div>
        
        <!-- Feedback Tab -->
        <div id="feedback" class="tab-content">
            <div class="card">
                <h3>‚≠ê User Feedback</h3>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadFeedback()">üîÑ Refresh</button>
                </div>
                <div id="feedbackList">
                    <p class="loading">Click refresh to load feedback...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        
        // Tab navigation
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            if (tabId === 'dashboard') loadDashboard();
        }
        
        // Load saved credentials
        window.onload = function() {
            var savedUrl = localStorage.getItem('obonato_admin_url');
            var savedKey = localStorage.getItem('obonato_admin_key');
            
            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseKey').value = savedKey;
                initDatabase(savedUrl, savedKey);
            }
        };
        
        // Initialize database
        function initDatabase(url, key) {
            try {
                db = window.supabase.createClient(url, key);
                updateStatus(true);
                loadTableStatus();
                return true;
            } catch (error) {
                console.error('Init error:', error);
                updateStatus(false);
                return false;
            }
        }
        
        // Test connection
        async function handleTestConnection() {
            var url = document.getElementById('supabaseUrl').value.trim();
            var key = document.getElementById('supabaseKey').value.trim();
            var result = document.getElementById('connectionResult');
            
            if (!url || !key) {
                result.innerHTML = '<div class="alert alert-danger">Enter both URL and Key</div>';
                return;
            }
            
            result.innerHTML = '<div class="alert alert-info">Testing...</div>';
            
            try {
                var testClient = window.supabase.createClient(url, key);
                var response = await testClient.from('profiles').select('count', { count: 'exact', head: true });
                
                if (response.error && !response.error.message.includes('does not exist')) {
                    throw response.error;
                }
                
                result.innerHTML = '<div class="alert alert-success">‚úÖ Connected! Click Save to continue.</div>';
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">‚ùå ' + error.message + '</div>';
            }
        }
        
        // Save connection
        function handleSaveConnection() {
            var url = document.getElementById('supabaseUrl').value.trim();
            var key = document.getElementById('supabaseKey').value.trim();
            
            localStorage.setItem('obonato_admin_url', url);
            localStorage.setItem('obonato_admin_key', key);
            
            if (initDatabase(url, key)) {
                document.getElementById('connectionResult').innerHTML = '<div class="alert alert-success">‚úÖ Connected and saved!</div>';
            }
        }
        
        // Clear connection
        function handleClearConnection() {
            localStorage.removeItem('obonato_admin_url');
            localStorage.removeItem('obonato_admin_key');
            document.getElementById('supabaseUrl').value = '';
            document.getElementById('supabaseKey').value = '';
            db = null;
            updateStatus(false);
        }
        
        // Update status badge
        function updateStatus(connected) {
            var badge = document.getElementById('connectionStatus');
            badge.textContent = connected ? 'Connected' : 'Not Connected';
            badge.className = 'status-badge ' + (connected ? 'status-connected' : 'status-disconnected');
        }
        
        // Load table status
        async function loadTableStatus() {
            if (!db) return;
            
            var div = document.getElementById('tableStatus');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            var tables = ['profiles', 'user_availability', 'sos_alerts', 'messages', 'feedback'];
            var html = '<table><tr><th>Table</th><th>Status</th><th>Records</th></tr>';
            
            for (var i = 0; i < tables.length; i++) {
                var table = tables[i];
                try {
                    var response = await db.from(table).select('*', { count: 'exact', head: true });
                    if (response.error) {
                        html += '<tr><td>' + table + '</td><td>‚ùå</td><td>-</td></tr>';
                    } else {
                        html += '<tr><td>' + table + '</td><td>‚úÖ</td><td>' + (response.count || 0) + '</td></tr>';
                    }
                } catch (e) {
                    html += '<tr><td>' + table + '</td><td>‚ùå</td><td>-</td></tr>';
                }
            }
            
            html += '</table>';
            div.innerHTML = html;
        }
        
        // Load dashboard
        async function loadDashboard() {
            if (!db) return;
            
            try {
                var usersRes = await db.from('profiles').select('*', { count: 'exact', head: true });
                var helpersRes = await db.from('user_availability').select('*', { count: 'exact', head: true }).eq('is_available', true);
                var sosRes = await db.from('sos_alerts').select('*', { count: 'exact', head: true }).eq('status', 'active');
                var feedbackRes = await db.from('feedback').select('*', { count: 'exact', head: true });
                
                document.getElementById('statUsers').textContent = usersRes.count || 0;
                document.getElementById('statHelpers').textContent = helpersRes.count || 0;
                document.getElementById('statSOS').textContent = sosRes.count || 0;
                document.getElementById('statFeedback').textContent = feedbackRes.count || 0;
                
                var recentRes = await db
                    .from('sos_alerts')
                    .select('*, profiles(display_name)')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                var html = '<table><tr><th>Time</th><th>Type</th><th>User</th><th>Status</th></tr>';
                if (recentRes.data && recentRes.data.length) {
                    recentRes.data.forEach(function(a) {
                        var userName = (a.profiles && a.profiles.display_name) || 'Unknown';
                        html += '<tr><td>' + new Date(a.created_at).toLocaleString() + '</td><td>' + a.alert_type + '</td><td>' + userName + '</td><td>' + a.status + '</td></tr>';
                    });
                } else {
                    html += '<tr><td colspan="4">No recent activity</td></tr>';
                }
                html += '</table>';
                document.getElementById('recentActivity').innerHTML = html;
                
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        // Load users
        async function loadUsers() {
            if (!db) {
                alert('Connect to database first');
                return;
            }
            
            var div = document.getElementById('usersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No users found.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Name</th><th>Email</th><th>Phone</th><th>Country</th><th>Created</th><th>Actions</th></tr>';
                data.forEach(function(u) {
                    html += '<tr>';
                    html += '<td>' + (u.display_name || u.first_name || '-') + '</td>';
                    html += '<td>' + (u.email || '-') + '</td>';
                    html += '<td>' + (u.phone || '-') + '</td>';
                    html += '<td>' + (u.country || '-') + '</td>';
                    html += '<td>' + (u.created_at ? new Date(u.created_at).toLocaleDateString() : '-') + '</td>';
                    html += '<td><button class="btn btn-sm btn-danger" onclick="deleteUser(\'' + u.id + '\')">üóëÔ∏è</button></td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Load helpers
        async function loadHelpers() {
            if (!db) return;
            
            var div = document.getElementById('helpersList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('user_availability')
                    .select('*, profiles(display_name, first_name)')
                    .order('updated_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No helper records.</div>';
                    return;
                }
                
                var html = '<table><tr><th>User</th><th>Location</th><th>Available</th><th>Services</th><th>Radius</th></tr>';
                data.forEach(function(h) {
                    var services = [];
                    if (h.can_pickup) services.push('üöó');
                    if (h.can_provide_garage) services.push('üîß');
                    if (h.can_provide_accommodation) services.push('üè†');
                    if (h.can_meet_for_drinks) services.push('üç∫');
                    if (h.can_provide_local_advice) services.push('üí°');
                    
                    var userName = (h.profiles && h.profiles.display_name) || (h.profiles && h.profiles.first_name) || '-';
                    
                    html += '<tr>';
                    html += '<td>' + userName + '</td>';
                    html += '<td>' + (h.current_location_name || '-') + '</td>';
                    html += '<td>' + (h.is_available ? '‚úÖ' : '‚ùå') + '</td>';
                    html += '<td>' + (services.join(' ') || '-') + '</td>';
                    html += '<td>' + (h.max_help_radius_km || '-') + ' km</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Load SOS alerts
        async function loadSOSAlerts() {
            if (!db) return;
            
            var div = document.getElementById('sosList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('sos_alerts')
                    .select('*, profiles(display_name)')
                    .order('created_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No SOS alerts.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Time</th><th>User</th><th>Type</th><th>Severity</th><th>Status</th><th>Actions</th></tr>';
                data.forEach(function(a) {
                    var sevColor = a.severity === 'critical' ? 'var(--danger)' : (a.severity === 'high' ? 'var(--warning)' : 'inherit');
                    var userName = (a.profiles && a.profiles.display_name) || '-';
                    
                    html += '<tr>';
                    html += '<td>' + new Date(a.created_at).toLocaleString() + '</td>';
                    html += '<td>' + userName + '</td>';
                    html += '<td>' + a.alert_type + '</td>';
                    html += '<td style="color: ' + sevColor + '">' + a.severity + '</td>';
                    html += '<td>' + a.status + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-success" onclick="resolveAlert(\'' + a.id + '\')">‚úÖ</button> ';
                    html += '<button class="btn btn-sm btn-danger" onclick="deleteAlert(\'' + a.id + '\')">üóëÔ∏è</button>';
                    html += '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Load feedback
        async function loadFeedback() {
            if (!db) return;
            
            var div = document.getElementById('feedbackList');
            div.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                var response = await db
                    .from('feedback')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (response.error) throw response.error;
                
                var data = response.data;
                if (!data || data.length === 0) {
                    div.innerHTML = '<div class="alert alert-info">No feedback yet.</div>';
                    return;
                }
                
                var html = '<table><tr><th>Time</th><th>Rating</th><th>Comment</th></tr>';
                data.forEach(function(f) {
                    var stars = '';
                    for (var i = 0; i < (f.rating || 0); i++) stars += '‚≠ê';
                    
                    html += '<tr>';
                    html += '<td>' + new Date(f.created_at).toLocaleString() + '</td>';
                    html += '<td>' + (stars || '-') + '</td>';
                    html += '<td>' + (f.comment || '-') + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
        
        // Delete user
        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            var response = await db.from('profiles').delete().eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadUsers();
        }
        
        // Resolve alert
        async function resolveAlert(id) {
            var response = await db.from('sos_alerts').update({ status: 'resolved' }).eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadSOSAlerts();
        }
        
        // Delete alert
        async function deleteAlert(id) {
            if (!confirm('Delete this alert?')) return;
            var response = await db.from('sos_alerts').delete().eq('id', id);
            if (response.error) alert('Error: ' + response.error.message);
            else loadSOSAlerts();
        }
        
        // Create test SOS
        async function createTestSOS() {
            if (!db) return;
            
            var response = await db.from('sos_alerts').insert({
                alert_type: 'breakdown',
                severity: 'medium',
                description: 'Test SOS alert - please ignore',
                status: 'active',
                latitude: -36.8485 + (Math.random() - 0.5) * 0.1,
                longitude: 174.7633 + (Math.random() - 0.5) * 0.1,
                created_at: new Date().toISOString()
            });
            
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                alert('Test SOS created!');
                loadSOSAlerts();
            }
        }
    </script>
</body>
</html>
